<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الطلاب - مدرسة ابن خفاجة</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap');
        
        * {
            font-family: 'Tajawal', sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
            transition: background 0.5s ease;
        }
        
        /* وضع الطوارئ */
        body.emergency-mode {
            background: linear-gradient(135deg, #ff0000 0%, #cc0000 100%);
            animation: emergency-pulse 1s infinite alternate;
        }
        
        @keyframes emergency-pulse {
            from { opacity: 0.9; }
            to { opacity: 1; }
        }
        
        /* تنبيه الطوارئ */
        .emergency-alert {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 0, 0, 0.9);
            z-index: 9999;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            color: white;
        }
        
        .emergency-alert.active {
            display: flex;
        }
        
        .emergency-alert h1 {
            font-size: 4rem;
            margin-bottom: 20px;
            animation: emergency-blink 1s infinite;
        }
        
        @keyframes emergency-blink {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .emergency-alert p {
            font-size: 1.5rem;
            margin-bottom: 30px;
        }
        
        .emergency-stop-btn {
            background-color: white;
            color: red;
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1.2rem;
            cursor: pointer;
        }
        
        /* زر الطوارئ */
        .emergency-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #ff0000;
            color: white;
            border: none;
            font-size: 1.5rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            cursor: pointer;
            z-index: 1000;
            transition: all 0.3s;
        }
        
        .emergency-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 12px rgba(0,0,0,0.4);
        }
        
        /* صفحة الغياب المرتفع */
        .high-absence-page {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin: 20px auto;
            max-width: 1200px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }
        
        /* صفحة التقارير */
        .reports-page {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin: 20px auto;
            max-width: 1200px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }
        
        /* صفحة غياب المدرسة */
        .school-absence-page {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin: 20px auto;
            max-width: 1400px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }
        
        .filter-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }
        
        .absence-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .absence-table th, .absence-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: right;
        }
        
        .absence-table th {
            background-color: #f2f2f2;
            font-weight: 600;
        }
        
        .absence-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .absence-table tr:hover {
            background-color: #f1f1f1;
        }
        
        /* أنماط أخرى */
        .initial-loading {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            color: white;
            font-size: 1.5rem;
        }
        
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-card {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 450px;
            text-align: center;
        }
        
        .login-logo i {
            font-size: 4rem;
            color: #667eea;
            margin-bottom: 15px;
        }
        
        .login-title {
            color: #333;
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .login-subtitle {
            color: #666;
            font-size: 1rem;
            margin-bottom: 30px;
        }
        
        .password-input {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 15px;
            font-size: 1.1rem;
            transition: all 0.3s;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .password-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .login-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s;
            color: white;
            width: 100%;
            font-size: 1.1rem;
        }
        
        .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .error-message {
            color: #dc3545;
            margin-top: 15px;
            font-size: 0.95rem;
            display: none;
        }
        
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
            display: none;
        }
        
        .school-header {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .school-name {
            color: #764ba2;
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .system-title {
            color: #667eea;
            font-size: 1.5rem;
            font-weight: 500;
        }
        
        .search-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .search-input {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 12px 20px;
            font-size: 1.1rem;
            transition: all 0.3s;
        }
        
        .search-input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .class-tabs {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .nav-tabs .nav-link {
            color: #667eea;
            border: none;
            padding: 12px 25px;
            margin: 0 5px;
            border-radius: 10px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .student-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
            border: 2px solid transparent;
            position: relative;
        }
        
        .student-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            border-color: #667eea;
        }
        
        .student-name {
            color: #333;
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .student-class {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 10px;
        }
        
        .absence-indicator {
            background-color: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .mark-absence-btn {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .mark-absence-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
        }
        
        .action-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-left: 10px;
        }
        
        .badge-warning { background: #ffc107; color: #000; }
        .badge-danger { background: #dc3545; color: #fff; }
        .badge-info { background: #17a2b8; color: #fff; }
        .success { background: #28a745; color: #fff; }
        .badge-secondary { background: #6c757d; color: #fff; }
        
        .stats-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .stats-label {
            color: #666;
            font-size: 0.95rem;
            margin-top: 5px;
        }
        
        .btn-primary-custom {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s;
            color: white;
            margin: 0 5px;
        }
        
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .btn-print {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
            margin: 0 5px;
        }
        
        .btn-print:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .btn-settings {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
            margin: 0 5px;
        }
        
        .btn-settings:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }
        
        .btn-reports {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
            margin: 0 5px;
        }
        
        .btn-reports:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(23, 162, 184, 0.3);
        }
        
        .btn-absence {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
            margin: 0 5px;
        }
        
        .btn-absence:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
        }
        
        .no-results {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 1.1rem;
        }
        
        .student-page {
            background: white;
            border-radius: 20px;
            padding: 30px;
            margin: 20px auto;
            max-width: 1200px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }
        
        .student-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .info-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
        }
        
        .info-label {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .info-value {
            color: #333;
            font-size: 1.1rem;
        }
        
        .edit-btn {
            background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .edit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.3);
        }
        
        .save-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .cancel-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .action-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-right: 4px solid #667eea;
        }
        
        .action-date {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .action-type {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .action-note {
            color: #555;
            font-size: 0.95rem;
        }
        
        .student-photo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .print-toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #28a745;
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            font-weight: 500;
            z-index: 10000;
            display: none;
            animation: slideDown 0.5s ease-out;
        }
        
        @keyframes slideDown {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        
        .no-print {
            display: block !important;
        }
        
        @media print {
            body {
                background: white !important;
                color: black !important;
                font-size: 12pt;
                margin: 0;
                padding: 0;
            }
            
            .no-print {
                display: none !important;
            }
            
            .student-page {
                box-shadow: none;
                border: 1px solid #ddd;
                padding: 15px;
                margin: 0;
                max-width: 100%;
            }
            
            .student-header {
                background: #f0f0f0 !important;
                color: black !important;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                border: 1px solid #ddd;
            }
            
            .info-section {
                background: #f9f9f9 !important;
                border: 1px solid #ddd;
                page-break-inside: avoid;
                margin-bottom: 15px;
            }
            
            .action-item {
                background: #f9f9f9 !important;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
            
            .btn-print, .edit-btn, .save-btn, .cancel-btn {
                display: none !important;
            }
            
            /* تحسين تنسيق الطباعة للغياب */
            .absence-list-print {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
                margin-top: 15px;
            }
            
            .absence-item-print {
                background: #f9f9f9;
                border: 1px solid #ddd;
                border-radius: 5px;
                padding: 5px 10px;
                font-size: 11px;
                width: calc(25% - 10px);
                box-sizing: border-box;
            }
            
            .absence-date-print {
                font-weight: 600;
            }
            
            .absence-source-print {
                font-size: 10px;
                color: #666;
                background-color: #f0f0f0;
                padding: 1px 3px;
                border-radius: 3px;
                margin-right: 3px;
            }
        }
        
        .add-student-btn {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
            margin: 0 5px;
        }
        
        .add-student-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }
        
        .form-floating {
            margin-bottom: 1rem;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .toast-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1050;
        }
        
        .toast {
            background-color: #28a745;
            color: white;
            border-radius: 10px;
            padding: 15px 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .toast.error {
            background-color: #dc3545;
        }
        
        .toast.warning {
            background-color: #ffc107;
            color: #000;
        }
        
        .settings-header {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            margin-bottom: 20px;
        }
        
        .password-strength {
            height: 5px;
            margin-top: 5px;
            border-radius: 3px;
            background-color: #e9ecef;
        }
        
        .password-strength-bar {
            height: 100%;
            border-radius: 3px;
            width: 0;
            transition: width 0.3s;
        }
        
        .strength-weak {
            background-color: #dc3545;
            width: 33%;
        }
        
        .strength-medium {
            background-color: #ffc107;
            width: 66%;
        }
        
        .strength-strong {
            background-color: #28a745;
            width: 100%;
        }
        
        .password-requirements {
            font-size: 0.85rem;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .requirement {
            margin-top: 3px;
        }
        
        .requirement.met {
            color: #28a745;
        }
        
        .requirement.unmet {
            color: #dc3545;
        }
        
        .absence-list {
            margin-top: 20px;
        }
        
        .absence-item {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            border-right: 4px solid #dc3545;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .absence-date {
            font-weight: 600;
            color: #333;
        }
        
        .delete-absence-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            cursor: pointer;
        }
        
        .delete-absence-btn:hover {
            background: #c82333;
        }
        
        .report-tabs {
            margin-bottom: 20px;
        }
        
        .report-tabs .nav-link {
            color: #667eea;
            border: none;
            padding: 10px 20px;
            margin: 0 5px;
            border-radius: 8px;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .report-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .report-filter {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .date-range {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .bulk-actions {
            background: #e9ecef;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }
        
        .bulk-actions.active {
            display: block;
        }
        
        /* إضافة مسافة بين الأزرار في صفحة تقرير الطالب */
        .student-page .btn {
            margin: 0 5px;
        }
        
        .student-page .d-flex.justify-content-between .btn {
            margin: 0 5px;
        }
        
        .absence-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-present {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-absent {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        /* إضافة تنسيق لعرض إحصائيات الغياب */
        .absence-stats {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-around;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        /* إضافة تنسيق للعرض الشهري واليومي */
        .view-toggle {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .view-btn {
            padding: 8px 15px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .view-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        
        .monthly-view {
            display: none;
        }
        
        .daily-view {
            display: block;
        }
    </style>
</head>
<body>

    <!-- تنبيه الطوارئ -->
    <div class="emergency-alert" id="emergencyAlert">
        <h1><i class="fas fa-exclamation-triangle"></i> وضع الطوارئ</h1>
        <p>تم تفعيل وضع الطوارئ في المدرسة</p>
        <button class="emergency-stop-btn" onclick="stopEmergencyMode()">إيقاف الطوارئ</button>
    </div>

    <!-- زر الطوارئ -->
    <button class="emergency-btn" id="emergencyBtn" onclick="activateEmergencyMode()">
        <i class="fas fa-exclamation-triangle"></i>
    </button>

    <!-- رسالة التحميل الأولية -->
    <div class="initial-loading" id="initialLoading">
        <div>
            <i class="fas fa-spinner fa-spin"></i>
            <p>جاري تحميل النظام...</p>
        </div>
    </div>

    <!-- صفحة تسجيل الدخول -->
    <div class="login-container" id="loginPage" style="display: none;">
        <div class="login-card">
            <div class="login-logo">
                <i class="fas fa-graduation-cap"></i>
                <h2 class="login-title">نظام إدارة الطلاب</h2>
                <p class="login-subtitle">مدرسة ابن خفاجة</p>
            </div>
            <div class="mb-4">
                <input type="password" class="form-control password-input" id="passwordInput" 
                       placeholder="أدخل كلمة المرور" autocomplete="off">
                <div class="error-message" id="errorMessage">
                    <i class="fas fa-exclamation-circle"></i> كلمة المرور غير صحيحة، يرجى المحاولة مرة أخرى
                </div>
            </div>
            <button class="btn login-btn" onclick="checkPassword()">
                <i class="fas fa-sign-in-alt"></i> دخول
            </button>
        </div>
    </div>

    <div class="main-container" id="mainPage">
        <!-- رأس الصفحة -->
        <div class="school-header">
            <h1 class="school-name">مدرسة ابن خفاجة</h1>
            <p class="system-title">نظام إدارة الطلاب المتقدم</p>
            <div class="mt-3">
                <button class="btn btn-primary-custom" onclick="exportData()">
                    <i class="fas fa-download"></i> تصدير البيانات
                </button>
                <button class="btn btn-primary-custom" onclick="showAllStats()">
                    <i class="fas fa-chart-bar"></i> إحصائيات
                </button>
                <button class="btn btn-absence" id="schoolAbsenceBtn" onclick="showSchoolAbsencePage()" style="display: none;">
                    <i class="fas fa-calendar-times"></i> غياب المدرسة
                </button>
                <button class="btn btn-reports" id="reportsBtn" onclick="showReportsPage()" style="display: none;">
                    <i class="fas fa-file-alt"></i> التقارير
                </button>
                <button class="btn btn-primary-custom" id="highAbsenceBtn" onclick="showHighAbsencePage()" style="display: none;">
                    <i class="fas fa-exclamation-circle"></i> الغياب المرتفع
                </button>
                <button class="btn add-student-btn" id="addStudentBtn" onclick="showAddStudentModal()" style="display: none;">
                    <i class="fas fa-user-plus"></i> إضافة طالب
                </button>
                <button class="btn btn-settings" id="settingsBtn" onclick="showSettingsModal()" style="display: none;">
                    <i class="fas fa-cog"></i> الإعدادات
                </button>
                <button class="btn btn-danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
                </button>
            </div>
        </div>

        <!-- قسم البحث -->
        <div class="search-section">
            <div class="row">
                <div class="col-md-8">
                    <input type="text" class="form-control search-input" id="searchInput" 
                           placeholder="ابحث عن طالب بالاسم في جميع الصفوف...">
                </div>
                <div class="col-md-4">
                    <button class="btn btn-primary-custom w-100" onclick="searchStudents()">
                        <i class="fas fa-search"></i> بحث شامل
                    </button>
                </div>
            </div>
        </div>

        <!-- الإحصائيات -->
        <div class="row mb-4" id="statsSection">
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalStudents">0</div>
                    <div class="stats-label">إجمالي الطلاب</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalClasses">0</div>
                    <div class="stats-label">إجمالي الشعب</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <div class="stats-number" id="totalGrades">0</div>
                    <div class="stats-label">إجمالي الصفوف</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <button class="btn btn-print w-100" onclick="generatePrintableReport()">
                        <i class="fas fa-print"></i> طباعة التقرير
                    </button>
                </div>
            </div>
        </div>

        <!-- العمليات الجماعية -->
        <div class="bulk-actions" id="bulkActions">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <span id="selectedCount">0</span> طالب محدد
                </div>
                <div>
                    <button class="btn btn-danger" onclick="markBulkAbsence()">
                        <i class="fas fa-calendar-times"></i> تسجيل غياب للمحددين
                    </button>
                    <button class="btn btn-secondary" onclick="clearSelection()">
                        <i class="fas fa-times"></i> مسح التحديد
                    </button>
                </div>
            </div>
        </div>

        <!-- منطقة نتائج البحث -->
        <div id="searchResultsContainer" class="class-tabs" style="display: none;">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4><i class="fas fa-search"></i> نتائج البحث</h4>
                <button class="btn btn-secondary" onclick="clearSearch()">
                    <i class="fas fa-times"></i> مسح البحث
                </button>
            </div>
            <div class="row" id="searchResultsList">
                <!-- نتائج البحث ستظهر هنا -->
            </div>
        </div>

        <!-- تبويبات الصفوف -->
        <div id="classTabsContainer" class="class-tabs">
            <ul class="nav nav-tabs" id="classTabs" role="tablist">
                <!-- تبويبات الصفوف ستتم إضافتها ديناميكياً -->
            </ul>
            <div class="tab-content mt-4" id="classTabContent">
                <!-- محتوى التبويبات سيتم إضافته ديناميكياً -->
            </div>
        </div>
    </div>

    <!-- صفحة الطالب المخصصة -->
    <div class="student-page" id="studentPage">
        <!-- الأزرار العلوية -->
        <div class="d-flex justify-content-between align-items-center mb-4 no-print">
            <button class="btn btn-primary-custom" onclick="backToMain()">
                <i class="fas fa-arrow-right"></i> العودة للقائمة
            </button>
            <div>
                <button class="btn edit-btn me-2" id="editInfoBtn" onclick="toggleEditMode()" style="display: none;">
                    <i class="fas fa-edit"></i> تعديل المعلومات
                </button>
                <button class="btn btn-print" onclick="generatePrintableReport()">
                    <i class="fas fa-print"></i> طباعة التقرير
                </button>
            </div>
        </div>

        <!-- منطقة الطباعة -->
        <div id="printableArea">
            <div class="student-header">
                <div class="row align-items-center">
                    <div class="col-md-2 text-center">
                        <img src="https://picsum.photos/seed/student/120/120" alt="صورة الطالب" class="student-photo" id="studentPhoto">
                    </div>
                    <div class="col-md-10">
                        <h2 id="studentPageName">اسم الطالب</h2>
                        <p class="mb-2">الصف: <span id="studentPageClass"></span></p>
                        <p class="mb-0">الرقم الوطني: <span id="studentPageNationalId"></span></p>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="info-section">
                        <h5 class="mb-4">المعلومات الشخصية</h5>
                        <div class="mb-3">
                            <div class="info-label">الاسم الكامل</div>
                            <div class="info-value" id="displayName">-</div>
                            <input type="text" class="form-control d-none" id="editName">
                        </div>
                        <div class="mb-3">
                            <div class="info-label">الرقم الوطني</div>
                            <div class="info-value" id="displayNationalId">-</div>
                            <input type="text" class="form-control d-none" id="editNationalId">
                        </div>
                        <div class="mb-3">
                            <div class="info-label">تاريخ الميلاد</div>
                            <div class="info-value" id="displayBirthDate">-</div>
                            <input type="date" class="form-control d-none" id="editBirthDate">
                        </div>
                        <div class="mb-3">
                            <div class="info-label">العنوان</div>
                            <div class="info-value" id="displayAddress">-</div>
                            <input type="text" class="form-control d-none" id="editAddress">
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="info-section">
                        <h5 class="mb-4">معلومات الاتصال</h5>
                        <div class="mb-3">
                            <div class="info-label">هاتف ولي الأمر 1</div>
                            <div class="info-value" id="displayPhone1">-</div>
                            <input type="tel" class="form-control d-none" id="editPhone1">
                        </div>
                        <div class="mb-3">
                            <div class="info-label">هاتف ولي الأمر 2</div>
                            <div class="info-value" id="displayPhone2">-</div>
                            <input type="tel" class="form-control d-none" id="editPhone2">
                        </div>
                        <div class="mb-3">
                            <div class="info-label">البريد الإلكتروني</div>
                            <div class="info-value" id="displayEmail">-</div>
                            <input type="email" class="form-control d-none" id="editEmail">
                        </div>
                        <div class="mb-3">
                            <div class="info-label">اسم ولي الأمر</div>
                            <div class="info-value" id="displayParentName">-</div>
                            <input type="text" class="form-control d-none" id="editParentName">
                        </div>
                    </div>
                </div>
            </div>

            <!-- قسم سجل الغياب -->
            <div class="info-section">
                <div class="d-flex justify-content-between align-items-center mb-4 no-print">
                    <h5>سجل الغياب</h5>
                    <button class="btn btn-primary-custom" id="markAbsenceBtn" onclick="markSingleAbsenceFromPage()" style="display: none;">
                        <i class="fas fa-calendar-times"></i> تسجيل غياب
                    </button>
                </div>
                <div id="studentAbsencesList">
                    <!-- سجل الغياب سيظهر هنا -->
                </div>
            </div>

            <div class="info-section">
                <div class="d-flex justify-content-between align-items-center mb-4 no-print">
                    <h5>سجل الإجراءات</h5>
                    <button class="btn btn-primary-custom" id="addActionBtn" onclick="showAddActionModal()" style="display: none;">
                        <i class="fas fa-plus"></i> إضافة إجراء
                    </button>
                </div>
                <div id="studentActionsList">
                    <!-- سجل الإجراءات سيظهر هنا -->
                </div>
            </div>
        </div>

        <!-- أزرار الحفظ والإلغاء -->
        <div class="text-center mt-4 d-none" id="editButtons">
            <button class="btn save-btn me-2" onclick="saveStudentInfo()">
                <i class="fas fa-save"></i> حفظ التغييرات
            </button>
            <button class="btn cancel-btn" onclick="cancelEdit()">
                <i class="fas fa-times"></i> إلغاء
            </button>
        </div>
    </div>

    <!-- صفحة غياب المدرسة -->
    <div class="school-absence-page" id="schoolAbsencePage">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-calendar-times"></i> غياب المدرسة</h3>
            <button class="btn btn-secondary" onclick="backToMain()">
                <i class="fas fa-arrow-right"></i> العودة للقائمة
            </button>
        </div>
        
        <div class="filter-section">
            <div class="row">
                <div class="col-md-4">
                    <label for="absenceGradeFilter" class="form-label">الصف</label>
                    <select class="form-select" id="absenceGradeFilter" onchange="updateAbsenceClassFilter()">
                        <option value="">اختر الصف</option>
                        <option value="الصف العاشر">الصف العاشر</option>
                        <option value="الصف التاسع">الصف التاسع</option>
                        <option value="الصف الثامن">الصف الثامن</option>
                        <option value="الصف السابع">الصف السابع</option>
                        <option value="الصف السادس">الصف السادس</option>
                        <option value="الصف الخامس">الصف الخامس</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="absenceClassFilter" class="form-label">الشعبة</label>
                    <select class="form-select" id="absenceClassFilter" onchange="loadClassAbsences()">
                        <option value="">اختر الشعبة</option>
                        <!-- خيارات الشعب ستتم ملؤها ديناميكياً حسب الصف المحدد -->
                    </select>
                </div>
                <div class="col-md-4">
                    <label for="absenceDateFilter" class="form-label">التاريخ</label>
                    <input type="date" class="form-control" id="absenceDateFilter" onchange="loadClassAbsences()">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-md-12 d-flex align-items-end">
                    <div class="view-toggle">
                        <button class="view-btn active" id="dailyViewBtn" onclick="toggleView('daily')">عرض يومي</button>
                        <button class="view-btn" id="monthlyViewBtn" onclick="toggleView('monthly')">عرض شهري</button>
                    </div>
                    <div class="ms-auto">
                        <button class="btn btn-print me-2" onclick="printSchoolAbsenceReport()">
                            <i class="fas fa-print"></i> طباعة التقرير
                        </button>
                        <button class="btn btn-primary-custom" onclick="exportSchoolAbsenceToExcel()">
                            <i class="fas fa-file-excel"></i> تصدير إلى Excel
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- إحصائيات الغياب -->
        <div class="absence-stats" id="absenceStats">
            <div class="stat-item">
                <div class="stat-number" id="totalPresent">0</div>
                <div class="stat-label">إجمالي الحضور</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="totalAbsent">0</div>
                <div class="stat-label">إجمالي الغياب</div>
            </div>
            <div class="stat-item">
                <div class="stat-number" id="attendanceRate">0%</div>
                <div class="stat-label">نسبة الحضور</div>
            </div>
        </div>
        
        <!-- العرض اليومي -->
        <div class="daily-view" id="dailyView">
            <div class="table-responsive">
                <table class="absence-table" id="schoolAbsenceTable">
                    <thead>
                        <tr>
                            <th>اسم الطالب</th>
                            <th>الرقم الوطني</th>
                            <th>هاتف ولي الأمر</th>
                            <th>حالة الحضور</th>
                            <th>ملاحظات</th>
                        </tr>
                    </thead>
                    <tbody id="schoolAbsenceTableBody">
                        <!-- بيانات غياب المدرسة ستظهر هنا -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- العرض الشهري -->
        <div class="monthly-view" id="monthlyView">
            <div class="table-responsive">
                <table class="absence-table" id="monthlyAbsenceTable">
                    <thead>
                        <tr>
                            <th>اسم الطالب</th>
                            <th>الرقم الوطني</th>
                            <th>هاتف ولي الأمر</th>
                            <th>إجمالي أيام الغياب</th>
                            <th>تواريخ الغياب</th>
                        </tr>
                    </thead>
                    <tbody id="monthlyAbsenceTableBody">
                        <!-- بيانات الغياب الشهرية ستظهر هنا -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- صفحة الطلاب ذوي الغياب المرتفع -->
    <div class="high-absence-page" id="highAbsencePage">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-exclamation-circle"></i> الطلاب ذوي الغياب المرتفع</h3>
            <button class="btn btn-secondary" onclick="backToMain()">
                <i class="fas fa-arrow-right"></i> العودة للقائمة
            </button>
        </div>
        
        <div class="filter-section">
            <div class="row">
                <div class="col-md-6">
                    <label for="absenceFilter" class="form-label">فلترة حسب عدد أيام الغياب</label>
                    <select class="form-select" id="absenceFilter" onchange="filterHighAbsenceStudents()">
                        <option value="5">5 أيام فأكثر</option>
                        <option value="10">10 أيام فأكثر</option>
                        <option value="15">15 يوماً فأكثر</option>
                        <option value="23">23 يوماً فأكثر</option>
                    </select>
                </div>
                <div class="col-md-6 d-flex align-items-end">
                    <button class="btn btn-print me-2" onclick="printHighAbsenceReport()">
                        <i class="fas fa-print"></i> طباعة التقرير
                    </button>
                    <button class="btn btn-primary-custom" onclick="exportHighAbsenceToExcel()">
                        <i class="fas fa-file-excel"></i> تصدير إلى Excel
                    </button>
                </div>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="absence-table" id="highAbsenceTable">
                <thead>
                    <tr>
                        <th>اسم الطالب</th>
                        <th>الصف</th>
                        <th>الرقم الوطني</th>
                        <th>هاتف ولي الأمر</th>
                        <th>مجموع أيام الغياب</th>
                        <th>تواريخ الغياب</th>
                    </tr>
                </thead>
                <tbody id="highAbsenceTableBody">
                    <!-- بيانات الطلاب ذوي الغياب المرتفع ستظهر هنا -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- صفحة التقارير -->
    <div class="reports-page" id="reportsPage">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3><i class="fas fa-file-alt"></i> التقارير</h3>
            <button class="btn btn-secondary" onclick="backToMain()">
                <i class="fas fa-arrow-right"></i> العودة للقائمة
            </button>
        </div>
        
        <ul class="nav nav-tabs report-tabs" id="reportTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="absence-tab" data-bs-toggle="tab" data-bs-target="#absence-tab-pane" type="button" role="tab" aria-controls="absence-tab-pane" aria-selected="true">تقارير الغياب</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="actions-tab" data-bs-toggle="tab" data-bs-target="#actions-tab-pane" type="button" role="tab" aria-controls="actions-tab-pane" aria-selected="false">تقارير الإجراءات</button>
            </li>
        </ul>
        
        <div class="tab-content" id="reportTabContent">
            <!-- تبويب تقارير الغياب -->
            <div class="tab-pane fade show active" id="absence-tab-pane" role="tabpanel" aria-labelledby="absence-tab" tabindex="0">
                <div class="report-filter">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="reportGradeFilter" class="form-label">الصف</label>
                            <select class="form-select" id="reportGradeFilter" onchange="updateReportClassFilter()">
                                <option value="">جميع الصفوف</option>
                                <option value="الصف العاشر">الصف العاشر</option>
                                <option value="الصف التاسع">الصف التاسع</option>
                                <option value="الصف الثامن">الصف الثامن</option>
                                <option value="الصف السابع">الصف السابع</option>
                                <option value="الصف السادس">الصف السادس</option>
                                <option value="الصف الخامس">الصف الخامس</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="reportClassFilter" class="form-label">الشعبة</label>
                            <select class="form-select" id="reportClassFilter" onchange="filterAbsenceReport()">
                                <option value="">جميع الشعب</option>
                                <!-- خيارات الشعب ستتم ملؤها ديناميكياً حسب الصف المحدد -->
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="reportDateFilter" class="form-label">الفترة</label>
                            <select class="form-select" id="reportDateFilter" onchange="filterAbsenceReport()">
                                <option value="all">جميع الفترات</option>
                                <option value="9">شهر 9</option>
                                <option value="10">شهر 10</option>
                                <option value="system">النظام فقط</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12 d-flex align-items-end">
                            <button class="btn btn-print me-2" onclick="printAbsenceReport()">
                                <i class="fas fa-print"></i> طباعة التقرير
                            </button>
                            <button class="btn btn-primary-custom" onclick="exportAbsenceReportToExcel()">
                                <i class="fas fa-file-excel"></i> تصدير إلى Excel
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="absence-table" id="absenceReportTable">
                        <thead>
                            <tr>
                                <th>اسم الطالب</th>
                                <th>الصف</th>
                                <th>الرقم الوطني</th>
                                <th>هاتف ولي الأمر</th>
                                <th>مجموع الغياب</th>
                                <th>تواريخ الغياب</th>
                            </tr>
                        </thead>
                        <tbody id="absenceReportTableBody">
                            <!-- بيانات تقرير الغياب ستظهر هنا -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- تبويب تقارير الإجراءات -->
            <div class="tab-pane fade" id="actions-tab-pane" role="tabpanel" aria-labelledby="actions-tab" tabindex="0">
                <div class="report-filter">
                    <div class="row">
                        <div class="col-md-4">
                            <label for="actionsGradeFilter" class="form-label">الصف</label>
                            <select class="form-select" id="actionsGradeFilter" onchange="updateActionsClassFilter()">
                                <option value="">جميع الصفوف</option>
                                <option value="الصف العاشر">الصف العاشر</option>
                                <option value="الصف التاسع">الصف التاسع</option>
                                <option value="الصف الثامن">الصف الثامن</option>
                                <option value="الصف السابع">الصف السابع</option>
                                <option value="الصف السادس">الصف السادس</option>
                                <option value="الصف الخامس">الصف الخامس</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="actionsClassFilter" class="form-label">الشعبة</label>
                            <select class="form-select" id="actionsClassFilter" onchange="filterActionsReport()">
                                <option value="">جميع الشعب</option>
                                <!-- خيارات الشعب ستتم ملؤها ديناميكياً حسب الصف المحدد -->
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="actionsTypeFilter" class="form-label">نوع الإجراء</label>
                            <select class="form-select" id="actionsTypeFilter" onchange="filterActionsReport()">
                                <option value="">جميع الإجراءات</option>
                                <option value="مغادرة">مغادرة</option>
                                <option value="تنبيه">تنبيه</option>
                                <option value="إنذار">إنذار</option>
                                <option value="استدعاء ولي أمر">استدعاء ولي أمر</option>
                                <option value="مخالفة">مخالفة</option>
                                <option value="تأخير">تأخير</option>
                                <option value="تبليغ غياب">تبليغ غياب</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12 d-flex align-items-end">
                            <button class="btn btn-print me-2" onclick="printActionsReport()">
                                <i class="fas fa-print"></i> طباعة التقرير
                            </button>
                            <button class="btn btn-primary-custom" onclick="exportActionsReportToExcel()">
                                <i class="fas fa-file-excel"></i> تصدير إلى Excel
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="absence-table" id="actionsReportTable">
                        <thead>
                            <tr>
                                <th>اسم الطالب</th>
                                <th>الصف</th>
                                <th>نوع الإجراء</th>
                                <th>التاريخ</th>
                                <th>الوقت</th>
                                <th>الملاحظات</th>
                            </tr>
                        </thead>
                        <tbody id="actionsReportTableBody">
                            <!-- بيانات تقرير الإجراءات ستظهر هنا -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة طالب -->
    <div class="modal fade" id="addStudentModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة طالب جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="addStudentForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="newStudentName" placeholder="اسم الطالب" required>
                                    <label for="newStudentName">اسم الطالب الكامل</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="newStudentNationalId" placeholder="الرقم الوطني">
                                    <label for="newStudentNationalId">الرقم الوطني</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="date" class="form-control" id="newStudentBirthDate" placeholder="تاريخ الميلاد">
                                    <label for="newStudentBirthDate">تاريخ الميلاد</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="newStudentAddress" placeholder="العنوان">
                                    <label for="newStudentAddress">العنوان</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="tel" class="form-control" id="newStudentPhone1" placeholder="هاتف ولي الأمر 1">
                                    <label for="newStudentPhone1">هاتف ولي الأمر 1</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="tel" class="form-control" id="newStudentPhone2" placeholder="هاتف ولي الأمر 2">
                                    <label for="newStudentPhone2">هاتف ولي الأمر 2</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="email" class="form-control" id="newStudentEmail" placeholder="البريد الإلكتروني">
                                    <label for="newStudentEmail">البريد الإلكتروني</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control" id="newStudentParentName" placeholder="اسم ولي الأمر">
                                    <label for="newStudentParentName">اسم ولي الأمر</label>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="newStudentGrade" required>
                                        <option value="" selected disabled>اختر الصف</option>
                                        <option value="الصف العاشر">الصف العاشر</option>
                                        <option value="الصف التاسع">الصف التاسع</option>
                                        <option value="الصف الثامن">الصف الثامن</option>
                                        <option value="الصف السابع">الصف السابع</option>
                                        <option value="الصف السادس">الصف السادس</option>
                                        <option value="الصف الخامس">الصف الخامس</option>
                                    </select>
                                    <label for="newStudentGrade">الصف الدراسي</label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating mb-3">
                                    <select class="form-select" id="newStudentClass" required>
                                        <option value="" selected disabled>اختر الشعبة</option>
                                        <!-- خيارات الشعب ستتم ملؤها ديناميكياً حسب الصف المحدد -->
                                    </select>
                                    <label for="newStudentClass">الشعبة</label>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary-custom" onclick="addNewStudent()">إضافة الطالب</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة الإعدادات -->
    <div class="modal fade" id="settingsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="settings-header">
                    <h5 class="modal-title"><i class="fas fa-cog me-2"></i>إعدادات النظام</h5>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="password-tab" data-bs-toggle="tab" data-bs-target="#password-tab-pane" type="button" role="tab" aria-controls="password-tab-pane" aria-selected="true">تغيير كلمة المرور</button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="system-tab" data-bs-toggle="tab" data-bs-target="#system-tab-pane" type="button" role="tab" aria-controls="system-tab-pane" aria-selected="false">معلومات النظام</button>
                        </li>
                    </ul>
                    <div class="tab-content pt-3" id="settingsTabContent">
                        <div class="tab-pane fade show active" id="password-tab-pane" role="tabpanel" aria-labelledby="password-tab" tabindex="0">
                            <form id="changePasswordForm">
                                <div class="mb-3">
                                    <label for="currentPassword" class="form-label">كلمة المرور الحالية</label>
                                    <input type="password" class="form-control" id="currentPassword" required>
                                </div>
                                <div class="mb-3">
                                    <label for="newPassword" class="form-label">كلمة المرور الجديدة</label>
                                    <input type="password" class="form-control" id="newPassword" required>
                                    <div class="password-strength">
                                        <div class="password-strength-bar" id="passwordStrengthBar"></div>
                                    </div>
                                    <div class="password-requirements">
                                        <div class="requirement unmet" id="length-req">
                                            <i class="fas fa-times-circle"></i> 8 أحرف على الأقل
                                        </div>
                                        <div class="requirement unmet" id="uppercase-req">
                                            <i class="fas fa-times-circle"></i> حرف كبير واحد على الأقل
                                        </div>
                                        <div class="requirement unmet" id="number-req">
                                            <i class="fas fa-times-circle"></i> رقم واحد على الأقل
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="confirmPassword" class="form-label">تأكيد كلمة المرور الجديدة</label>
                                    <input type="password" class="form-control" id="confirmPassword" required>
                                    <div class="invalid-feedback">
                                        كلمتا المرور غير متطابقتين
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="system-tab-pane" role="tabpanel" aria-labelledby="system-tab" tabindex="0">
                            <div class="mb-3">
                                <label class="form-label">اسم المدرسة</label>
                                <input type="text" class="form-control" id="schoolName" value="مدرسة ابن خفاجة">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">اسم النظام</label>
                                <input type="text" class="form-control" id="systemName" value="نظام إدارة الطلاب المتقدم">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">الإصدار</label>
                                <input type="text" class="form-control" id="systemVersion" value="1.0.0" readonly>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">تاريخ آخر نسخة احتياطية</label>
                                <input type="text" class="form-control" id="lastBackup" value="غير متوفر" readonly>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary-custom" onclick="saveSettings()">حفظ التغييرات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة إضافة إجراء -->
    <div class="modal fade" id="addActionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة إجراء جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">نوع الإجراء</label>
                        <select class="form-select" id="newActionType">
                            <option value="">اختر الإجراء...</option>
                            <option value="مغادرة">مغادرة</option>
                            <option value="تنبيه">تنبيه</option>
                            <option value="إنذار">إنذار</option>
                            <option value="استدعاء ولي أمر">استدعاء ولي أمر</option>
                            <option value="مخالفة">مخالفة</option>
                            <option value="تأخير">تأخير</option>
                            <option value="تبليغ غياب">تبليغ غياب</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">الملاحظات</label>
                        <textarea class="form-control" id="newActionNote" rows="3" placeholder="أدخل ملاحظاتك هنا..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary-custom" onclick="addNewAction()">إضافة</button>
                </div>
            </div>
        </div>
    </div>

    <!-- رسالة التأكيد -->
    <div class="toast-container">
        <div class="toast" id="successToast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-body">
                <i class="fas fa-check-circle me-2"></i>
                <span id="toastMessage">تمت العملية بنجاح!</span>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // بيانات الطلاب
        const studentsData = {
            "الصف العاشر": {
                "10أ": [
                    "احمد حمزة موسى فلاح", "احمد سمير عبد الله احمد", "احمد فواز عبدالهادي الخلايلة",
                    "ايهم علي موسى الحجوج", "باسل مراد عبدالحافظ الخلايلة", "حاتم مؤيد ناجي الحنتولي",
                    "حمزه سمير محمود سليمان", "حمزه محمد شحاده اذهيبه", "خليفه ابراهيم حسني خليفه",
                    "ريان حاتم عناد العيسى", "ريان عبد الكريم خلف ابو هزيم", "عادل جمال عبد المنعم ابداح",
                    "عبد الله احمد كامل الخلايلة", "عبدالله خلدون محمد الخلايله", "علي عصام سلمان الخلايلة",
                    "علي فراس علي الكباريتي", "عمر احمد جابر احمد", "عمر خالد حسين الفارغه",
                    "عمر غسان حسن حموه", "عمر محمد عبد الرحيم الخلايله", "قيس خليل محمد اطفيحه",
                    "قيس يحيى عطيه درويش", "كريم محمد مصطفى الرافعي", "مؤيد ماجد إبراهيم القزق",
                    "محمد عدنان حسين النفيعات", "محمود ابراهيم خلف ابوهزيم", "محمود عبدالحميد محمد عياش",
                    "مشعل وليد حميده عفانه", "مصطفى محمد محمود حماد", "معتز احمد سالم المزايده",
                    "وديع بلال عادل ابوالسعود", "وسيم فواز عبد الحليم الخلايله", "ياسين عمر عبد الرحمن الحياري",
                    "يامن فيصل محمد ابو الرب", "يزن عزيز رياض العربي", "يمان محمد فتحي عوده",
                    "يوسف محمد موسى فلاح"
                ],
                "10ب": [
                    "اسامه باسم تميم سلهب", "الياس رامي عيد ابو جاد الله", "امير حمزة سالم ارشيدات",
                    "انس محمود عبد الرؤوف صوص", "ايهم انس محمود الهندي", "ايهم يحيى بدوى الغرابلي",
                    "بكر محمد نمر طلوزي", "حاتم طارق حاكم العليوات", "حسن حامد حسن ابو صره",
                    "خليل ثابت زهدي ثابت", "راشد عدنان عيسى الدغيمات", "ريان باسم عبد اللطيف جلغوم",
                    "زيد حسان وجيه سلمان", "زيد محمود سالم ابو طراد", "زيد معتز فؤاد جبريل",
                    "زيد نورالدين محمد الخلايله", "سلطان محمد احمد السيد احمد", "صالح محمد علي الشوره",
                    "طارق شوقي يوسف الحسن", "عباده عبدالحميد مصباح الجابر", "عبد الرحمن احمد عبد الرحمن عفانة",
                    "عبد الرحمن مؤمن عارف جرادات", "عبد الرحمن هاشم محمد الخلايله", "عبد الله سليمان يوسف الشملة",
                    "عبد الله محمد عبد الله المومني", "عبد الهادي سامر عواد ابو هزيم", "عمر اشرف محمد محمد",
                    "غسان ايمن احمد القلالوه", "ليث حسام حسن حسن", "محمد اسماعيل مصطفى اسماعيل",
                    "محمد باسم عبد اللطيف جلغوم", "محمد ماجد احمد يوسف", "محمد محمود احمد محمود",
                    "محمد ياسين سامي ابراهيم", "نبيل سمير محمد عواد", "نسيم مهند محمد ابو السعود",
                    "همام معاذ ضيف الله الخلايله", "يوسف محمد محمود الزيود"
                ],
                "10ج": [
                    "احمد صالح احمد الخلايلة", "احمد محمد احمود الدغيمات", "اسامه ابراهيم العلي",
                    "امجد محمد ابراهيم جاموس", "انس محمود احمد الخلايله", "ايهم محمد ابراهيم ابريوش",
                    "ايوب سليمان الجراد", "جميل عبد الرحمن جميل الحلحولي", "حسام حمزه احمد ابو السعود",
                    "ريان بلال علي السيلاوي", "زيد وليد محمد محمود", "زين الدين حازم يعقوب ابوسنينه",
                    "سامر مطر عبد الجابر عوده", "عبد الحليم احمد عبد الحليم الخلايله", "عبدالله علي عبدالله الخلايلة",
                    "عدي محمد جمال خضر", "علاء فراس علي الكباريتي", "علي خليل علي أبو سليم",
                    "قيس اسامه موفق سليمان", "قيس عبد الحكيم علي مستريحي", "ليث رائد محمود جبر",
                    "محمد بلال احمد المشلوح المزايده", "محمد خير احمد المحمد", "محمد سمير عبدالله احمد",
                    "محمد عبد المطلب الرحيم", "محمد عبد الناصر رشاد علي", "محمد علي محمود مستريحي",
                    "محمد فادي محمد الصفدي", "محمد وليد شحاده شحاده", "محمود فراس هاني احمد",
                    "هاشم حمزه عبد الكريم الخلايله", "يامن احمد عبد اللطيف العويدات", "ينال عمر محمد عيسى",
                    "يوسف علي صالح عبد المهدي", "يوسف فراس غازى عابد", "يوسف نضال ذيب زهران"
                ]
            },
            "الصف التاسع": {
                "9 أ": [
                    "ادهم ابراهيم احمد السوقي", "اسامه اسماعيل اسحق ابو عماره", "اسماعيل محمود سليمان اليماني",
                    "الياس ايمن محمد خميس التميمي", "جابر ايمن جابر احمد", "سامي جميل احمد الاسمر",
                    "سليمان محمد فنصه", "سيف الدين جودت سلامه الشباطات", "عباده عبد الرحمن محمد الحيارى",
                    "عبد الرازق بلال زكري الضميدي", "عبد الله محمد عبد الحميد الخلايله", "عز الدين سامي احمد ياسين",
                    "علي بلال احمد ابو سعيفان", "علي علاء صالح هندى", "قصي خميس سعد الدين عز",
                    "قصي مالك سمير قطنه", "ليث اشرف عبد اللطيف عراقي", "محمد ابراهيم حسني خليفه",
                    "محمد خالد عودة ابو هزيم", "محمد رائد يوسف الدغيمات", "محمد عمر عبد الرحيم الخلايله",
                    "محمد ياسر عبد الحافظ الفلاح", "محمود محمد حسن نصر", "نعيم زياد نعيم زياد",
                    "يزن احمد عبدالله الدغيمات", "يوسف محمود احمد الحيارى"
                ],
                "9 ب": [
                    "ابراهيم امين عبد المنعم ابداح", "احمد خالد فضل ابوخشبه", "اسامه احمد سعدي السويركي",
                    "اكرم امجد سالم ابوطراد", "امجد مجدي علي خليل", "امير خميس سعودى ابو مسلم",
                    "ايهم محمد احمد المومني", "ايوب احمد مصطفى الصوالحي", "بهجت نصر ابراهيم ابريوش",
                    "حسين عمر عدنان حسن", "خالد محمد خالد الشرافي", "ريان انس محمود الهنيدي",
                    "زيد عمار محمد سعيد السيد", "سالم محمد سالم ابو طراد", "سامي محمد سامي درويش",
                    "سند ياسر محمود الزقيبة", "عبد الرحمن عمر نبهان الصالح", "عبد الرحمن يحيى خليل عبد الدايم",
                    "عبد الله اشرف عبد الله الدهني", "عبدالله عمر محمد محمود", "عزام احمد باسم اللحام",
                    "عمر عادل عبد الكريم الدغيمات", "عمر مراد عاطف حسن", "قصي عمار محمد سعيد السيد",
                    "قيصر احمد وليد ماجد ابو خلف", "كنان مؤيد جميل خشبه", "محمود فراس محمد العليوات",
                    "معتز موسى ماجد ابو جحيشه", "يزن طه احمد الخلايله"
                ],
                "9ج": [
                    "احمد خير الدين المحمد", "احمد راضي يوسف الاجرب", "احمد رامي فتحي احمد",
                    "احمد عيسى خليل الدغيمات", "امجد نائل محمد عمير", "امير ابراهيم احمد خليفه",
                    "ايهم نائل محمد شناعة", "حسن عثمان ضيف الله الخلايلة", "خالد عبد الرحمن محمد محمود أبو شنب",
                    "راشد مروان احمد القرعان", "رعد مالك فتحي الحياري", "سيف الدين فراس فواز سليمان",
                    "صهيب محمد حسن عليمات", "ضياء الدين محمود سليمان عبد الجابر", "عامر نزيه عبد الجابر عوده",
                    "عبد الرحمن زياد احمد زقزوق", "عبد الرحمن موفق عبد الرزاق براهمه", "عبد الله عايد فريد محمود",
                    "عبيده محمد عطا ابراهيم", "علاء زياد شفيق اللحلوح", "علي جمال احمد خليفه",
                    "علي عدنان علي كنعان", "قصي احمد ذيب خريس", "قصي علي ابراهيم ابو حسينه",
                    "كرم ابراهيم شحاده النواجعه", "محمد جلال احمد خليفه", "محمد خير الدين المحمد", "محمد عماد الدين حابس الخالدي", "محمود كمال جميل محمود", "هاشم خالد يوسف السلمان",
                    "وسام مراد رشدي العطاونة", "يامن بلال محمد الحياري", "يحيى فراس محمد سلامه",
                    "يوسف محمد عيد جرادة"
                ],
                "9د": [
                    "ابراهيم محمد حسنى عبد المجيد", "احمد خليل سلمان الخلايله", "احمد عمار احمد خليفه",
                    "احمد عيد احمود الدغيمات", "اسامه بشير علي الجالودي", "اسامه عبد الحميد عبد الرحمن التميمي",
                    "اشرف رامي فتحي احمد", "راشد احمد بشير المصري", "راغب جواد عبد اللطيف ابو سيف",
                    "ريان جهاد عبدالحافظ الخلايلة", "ريان مصطفى محمد عبد الرحمن الشرافي", "زيد محمد علي علي",
                    "زيد محمود محمد عيسى", "سليمان عبدالله احمد ابو زر", "عبد الرحمن عدنان زكري جلغوم",
                    "عبد العزيز خالد محمد الخلايله", "عبدالله علي موسى فلاح", "عمر حمزه سليمان ابو سعيفان",
                    "قصي داود نصر عكيلة", "قصي عمر عبد الكريم الدغيمات", "ماجد محمود مصطفى الصوالحي", "محمد عزمي يوسف حماد", "محمد علي عبد الكريم الخلايله", "محمد محمود سلامة المصري",
                    "محمد محمود نعيم الجالودى", "محمد مصطفى محمد ابو خضر", "محمد مهند عصام عواد", "محمود بكر عيسى الدغيمات", "نبال بلال علي السيلاوي", "نوح فارس محمد العليوات",
                    "وسيم رائد ناصر أبو زر", "وليد محمد فلاح الصليبي", "يحيى منير حسين بدران",
                    "يوسف محمد محمود ابو صفيه"
                ]
            },
            "الصف الثامن": {
                "8أ": [
                    "احمد سليمان احمد النعيمات", "احمد عصام محمد عمر", "احمد محمد احمد عماش",
                    "ادم محمود علي عبد الله", "امير علي عبد ربه الخلايله", "انس احمد ماجد الجرادات",
                    "انس رجائي محمد السكافي", "اوس محمود عبدالرؤوف صوص", "بهاء الدين محمد احمد الرشايده",
                    "جمال محمود جمال خضر", "جميل فراس جميل يوسف", "حسن عمر احمد الحاج",
                    "حسن نبيل حسن حسين", "حمزة سلطان عبدالله الحطيبات", "حمزه احمد حسين حلحولي",
                    "زيد محمد علي الشورة", "زين العابدين احمد محمد سليم", "طارق وليد جميل المسعف",
                    "عباده كمال عبد الرحمن ابو جابر", "عباده وليد حلمي شوبكي", "عبد الكريم عدنان حسين النفيعات",
                    "عبد الله عمر محمود الحاج", "عبدالله جهاد حابس الخالدي", "عبدالله جهاد عبدالله الخلايله",
                    "عبدالله عصام ناصر الحايك", "عدي عمار محمد سعيد السيد", "عمار ابراهيم محمد سعيد كنانه",
                    "عمر احمد علي سليم", "فتحي مالك فتحي الحياري", "ليث خالد عمر الختالين",
                    "محمد جهاد حابس الخالدي", "محمد صابر عليان الهويمل", "محمد فواز عبدالحليم الخلايلة",
                    "محمد مهند هاني الدغيمات", "محمد موسى سعود عبود", "محي الدين زهير محمد عباد",
                    "معتز بالله سعيد عبد الرحمن مسلم", "وليد خالد عمر الختالين"
                ],
                "8ب": [
                    "ابراهيم علي ابراهيم ابراهيم", "احمد محمد فتحي جبر", "امير سليم علي السليم",
                    "جاد اسماعيل عارف الحجوج", "جلال خالد ابراهيم ابريوش", "جمعه ابراهيم الجاسم",
                    "زيد بلال سعدي عثمان", "سليم محمود علي السليم", "صالح محمد وجيه صالح",
                    "صهيب رائد سعدو الجمال", "عامر عمار احمد خليفه", "عبد الحكيم مؤمن عارف جرادات",
                    "عبد الرحمن سليمان طه عواد", "عبد الرحمن محمود عبد الله صدوق", "عبد الله زاهر محمد خليفه",
                    "عمار عامر رياض ابو شبايك", "عمر قاهر صبحي السيد", "عمر محمود محمد الدربي",
                    "عون احمد محمد الحجاحجه", "غازي محمد غازي عابد", "كرم زكريا محمد الخلايلة",
                    "محمد ابراهيم ماجد ابو جحيشه", "محمد ابراهيم محمد عبدالله", "محمد احمد عبدالحميد الخلايلة",
                    "محمد احمد كامل الخلايلة", "محمد صائب محمد مجدوبه", "محمود رياض محمود الخلايلة",
                    "نضال فراس علي الاطرش", "هاشم احمد محمود الزيود", "هاشم عمر هشام محمود",
                    "وائل محمد وائل عمير", "وسيم مصطفى محمد المومني", "وليد محمد علي السليم",
                    "يامن احمد عبد الرزاق السمان", "يامن محمد عزات حسن", "ينال جلال عبد الرحمن ابو جابر"
                ],
                "8ج": [
                    "احمد بشير ابراهيم ابو طعيمه", "احمد سلمان احمد الخلايلة", "احمد عبد المطلب الرحيم",
                    "احمد محمد محمود ابو سليم", "ادم رامي عيد ابوجادالله", "اشرف هيثم حميده حسين",
                    "اكرم محمود سالم ابو طراد", "ايهم علاء الدين احمد البد", "بكر جمال محمد ابو حسان",
                    "ثامر محمد احمد الخلايله", "ريان يوسف محمد ابو خضر", "سالم ارحيل سالم الخنازره",
                    "سالم محمد سليمان عبد الجابر", "عبد الكريم محمود محمد حراحشه", "عبد الله محمد اسعد بقيله",
                    "عبدالعزيز ياسين سامي ابراهيم", "عصام يوسف فندي شتيات", "علاءالدين محمود سليمان عبدالجابر",
                    "علي عمر عدنان حسن", "عمر وليد خالد الجداونه", "غيث كفاح مصباح داود",
                    "فايق رامي شحاده العماش", "فيصل لؤي الجاسم", "قصي وديع جودت يوسف",
                    "قيس احمد يعقوب يوسف", "مؤمن عبد الرحيم محمود اسعد", "محمد ابراهيم مصطفى خليفه",
                    "محمد احمد محمد ابو فرحه", "محمد اشرف حسين ابو عيشة", "محمد عبد الله حسن ابو صره",
                    "محمود ماجد احمد يوسف", "مشاري حمزة موسى فلاح", "هشام محمد صالح خليفه",
                    "ورد مهدى عبد الستار الخطيب", "يزن مصطفى محمود عبد الرحمن", "يعقوب مصطفي يعقوب حمدان",
                    "يوسف عمر سعيد خليل"
                ],
                "8د": [
                    "المعتصم بالله محمد احمد الخلايله", "ايوب حذيفه فؤاد حسين", "حبيب ناصر عبد الكريم الخلايله",
                    "حسن محمد حسن افياله", "حمزة عمر احمد السوقي", "حمزه نصر احمد محمد خليل",
                    "رائد اسامه علي الشواهنه", "رائد زكريا احمد الخليل", "رامز خالد محمود العبد الله",
                    "رسلان محمد حسن دارى", "رعد اسامة علي الشواهنة", "رياض مهند الجاسم",
                    "ريان حازم عبد اللطيف محمود", "ريان فيصل محمد أبو الرب", "سائد ابراهيم احمد الخلايله",
                    "سلطان محمد سند الحويطات", "سليمان احمد خلف الخلايله", "عامر ابراهيم احمد حسين",
                    "عبد الرحمن زياد محمد الخلايله", "عبد الفتاح مامون عبد الفتاح القيسي", "عمران رائد محمد الحواري",
                    "قصي احمد محمد الواوي", "قصي عز الدين احمد الخلايله", "كرم حازم يعقوب ابوسنينه",
                    "محمد امجد حميده حسين", "محمد تيسير امين ابو عطيه", "محمد خالد فضل ابو خشبه",
                    "محمد خليل محمد غيظان", "محمد سالم احمد ابو سعيفان", "محمد عماد عبد الكريم رمضان",
                    "محمود محمد محمود الخزاعة", "مصطفى مهند محمد ابو السعود", "موسى محمد موسى ابو حديد",
                    "يحيى محمد انور سلامه", "يزيد صلاح الدين احمد الحيارى", "يوسف عبد الكريم عثمان عيسى"
                ]
            },
            "الصف السابع": {
                "7أ": [
                    "آدم تيسير عبدالله الدغيمات", "احمد ابراهيم الجاسم", "احمد جهاد عبد العزيز يوسف",
                    "احمد عثمان عارف عثمان", "احمد علي احمد مهنا", "احمد محمد احمد غيضان",
                    "احمد محمد غراف الجدوع", "ادريس اشرف محمود اسعد", "ادم فراس هاني احمد",
                    "ادم محمد خالد الشرافي", "اسامه سليمان سالم المزايده", "امير محمود ناصر ابوزرد",
                    "اوس عمر علي الشافي", "جاد عبد الباسط عبد المعطي التميمي", "جبريل عبد الله ذيب الباز",
                    "جواد عمادالدين حابس الخالدي", "حسن بلال حسن غيظان", "حمزة فراس جميل يوسف",
                    "حمزه ايمن احمد مطلق", "ريان عدنان عيسى الدغيمات", "ريان فراس محمد الاشقر",
                    "ريان محمد كامل الخلايله", "زيد عطا عبدالرحمن الحياري", "عامر عارف عيسى فالح",
                    "عبد الرحمن محمود احمد ابو صايمه", "عمر شرف الدين محمد الترك", "عمر وائل يوسف الربايعة",
                    "فريد محمد فريد محمود", "قيس محمد سليمان عبد الجابر", "محمد ناصر عوض الخنازره",
                    "محمد نور وليد كلزي", "محمود منور عبد الرحمن الحيارى", "موسى عبد الهادى موسى الفقيه",
                    "نور الدين امجد علي خليل", "نورس عثمان نعيم الجالودي", "يوسف محمود احمد سالم"
                ],
                "7ب": [
                    "احمد معمر عباس الطيراوى", "الاسكندر محمد سالم الفقير", "اويس خالد عايد الدغيمات",
                    "خالد اسماعيل الحجي", "ربيع محمد سلمان الخلايلة", "ريان محمود خضر موسى",
                    "زيد فراس فواز سليمان", "زيد مروان احمد القرعان", "زين العابدين علي عسبلي الدغيمات",
                    "سالم احمد سالم المزايده", "صهيب طارق عادل ابوالسعود", "عادل عبد الله محمد الحراحشه", "عبيدة فادي سليمان فلاح", "عمار قاهر صبحي السيد", "فايز فواز عبد الحليم الخلايله", "قصي ثائر نضال أبو كتب", "محمد احمد عبد الله غيضان", "محمد احمد محمد بشير الغلبان", "محمد خالد ماجد مصطفى", "محمد رعد خالد ابو كوش", "محمد سعد محمد مسعد", "محمد محمود محمد الخلايله", "محمد محمود محمد خليفة", "محمد وسام عزان ابو الحج", "محمد وسام محمود عبد الرازق", "مصعب نافع احمد الخلايلة",
                    "معاذ محمود سلامة المصري", "ياسين علي موسى عبد الحميد", "يحيى صلاح جاهين موسى", "يوسف مصطفى جمعه جبر"
                ],
                "7ج": [
                    "احمد جهاد عبد الله الخلايله", "احمد فواز محمود عبود", "احمد محمد عواد ابو هزيم",
                    "احمد هاني احمد عدوان", "امجد عبدالمطلب موسى الرحيم", "ايهم زياد محمد محمود",
                    "ايهم صايل ابراهيم عرابي", "براء مصطفى محمد عبد الرحمن الشرافي", "جمعة محمد العلي",
                    "حسين عصام حسين الدوايده", "روحي محمود روحي عباس", "ريان مراد رشدي العطاونه",
                    "زيد اسامه عبد الله غيظان", "سند سلطان عبد الفتاح الحياري", "سيف الدين انس وليد ماجد ابو خلف",
                    "عبد الرحمن عايش محمد الحيارى", "عبد الله احمد امين ناصر", "عبدالله عمر محمد عيسى", "عصام مهند عصام عواد", "عمر راشد الجاسم", "عمر طالب محمد محمود",
                    "عمر فضل السيد علواني", "قصي محمد احمد الدغيمات", "لقمان عبد الحكيم علي مستريحي",
                    "مؤيد عمر علي السليم", "محمد احمد سعدي السويركي", "محمد خليل محمد اطفيحه",
                    "محمد شادي فرحان الزقاريط", "محمد مصطفى محمد المومني", "محمود ناصر محمود منصور",
                    "موسى محمد يوسف الدغيمات", "ميسره علي عبد الحفيظ الرحايله", "وسيم عبد الحميد محمد عياش",
                    "يامن خالد محمد الجعارات", "يامن محمد غازي عابد", "يامن وليد رحيم",
                    "يزن عبد الله عبد ربه الخلايله", "ينال نبيل محمود سليمان", "يوسف خالد يوسف السلمان",
                    "يوسف محمد عبد الحميد الخلايله"
                ]
            },
            "الصف السادس": {
                "6أ": [
                    "احمد خالد يوسف ابو محبوبه", "احمد رامي شحاده العماش", "احمد عبداللطيف عبدالحفيظ ناصر",
                    "احمد عمر محمد عيسى", "اسماعيل جمعه اسماعيل عبد الرازق", "الياس احمد محمود حمدان",
                    "امجد مهند عبد الله شلبي", "ايهم فادي محمد الصفدي", "جمال نايف موسى مصطفى",
                    "جواد سليم محمود عبود", "حمزه سمير محمد عواد", "خالد ابراهيم خالد عوده",
                    "سلطان معاويه محمد سعيد كنانه", "سند خالد عمر الطيور الختالين", "شامك وسام عبد الحفيظ الخلايله",
                    "صلاح حمزه عماد الخطيب", "عبد الرحمن ابراهيم جاسم", "عبد العزيز اسماعيل الحجي",
                    "عدي احمد محمد الواوي", "عمار حمزه سليمان ابو سعيفان", "عمر اكرم عمر الخلايله",
                    "عمر محمود مصطفى الصوالحي", "فايز محمد فايز ابو جحيشه", "كرم صالح احمد الخلايله",
                    "ليث اسامه موفق سليمان", "مجد محمد حسن نصر", "محمد احمد محمود شباب",
                    "محمد وليد طلب نشوان", "محمود إبراهيم محمود ترابي", "مصطفى محمد جميل البشايرة",
                    "معاذ معتصم حسين الدوايده", "وسام عيد احمود الدغيمات", "يامن راكان ابراهيم كنانه",
                    "يوسف عبد الرحمن جميل الحلحولي", "يوسف معتز محمد صلاح السكافي"
                ],
                "6ب": [
                    "احمد عصام محمد الخلايله", "احمد محمد مصطفى سلامه", "ادريس هاشم محمد الخلايله",
                    "امير عماد محمد الريالات", "امير محمد عبد الرحيم الخلايله", "باسل حسين التركي", "براء ابراهيم حسني خليفه", "جهاد احمد باسم اللحام", "حسن تركي التركي",
                    "حمزه عمر محمد حامد", "ريان حسين راجح عبد الجليل", "زهير موسى محمد الفقيه",
                    "سيف الدين انس سمير قطنه", "سيف الدين علاء احمد ابو جابر", "عادل فراس عادل لافي",
                    "عبد الرحمن احمد خلف الخلايله", "عبد الرحمن حمزه سليمان سليم", "عبد الرحمن علي جمال ناصر",
                    "عبد الرحمن محمد جمعه الحديدي", "عبد الله خليل محمود الخلايلة", "عدي همام ابراهيم المصري",
                    "علي فيصل يوسف البشتاوي", "عمار احمد يوسف ذيبان", "كرم سليمان ابراهيم اسماعيل",
                    "مؤيد عبد الله حسن ابو صره", "ماجد هاشم حامد الخلايلة", "محمد جلال خالد صلاحات",
                    "محمد عصام ناصر الحايك", "محمد علي سليمان الدغيمات", "محمد فراس فواز سليمان",
                    "محمد محمد نمر عبد الكريم قواس", "محمود سامي احمد ياسين", "مصطفى محمد حرب حمدان", "ميكائيل جلال عبد الرحمن أبو جابر", "نور محمد سلمان حامد"
                ],
                "6ج": [
                    "ابراهيم امجد سالم ابو طراد", "امير محمد محمود حمد", "اويس فوزي عبد الحليم الخلايله",
                    "ايهم متعب احمد العليوات", "بلال معاذ خليل عبد الدايم", "بهاء الدين احمد عبد الله غيظان", "جود وليد محمد محمود", "جوهر زكريا احمد الخليل", "خالد فارس خالد جاموس",
                    "رواد زياد شفيق الحلوح", "سليمان منير حسين بدران", "سيف محمد فتحي القطمش",
                    "عبد الرحمن محمود مصطفى افياله", "عبد الله طارق زياد خضر", "عبد المنعم سعيد الحسن",
                    "عدنان صايل ابراهيم عرابي", "علاء الدين صلاح سالم اجخيدم", "علي انس موسى ابو السعود",
                    "علي عثمان نعيم الجالودى", "عمر زياد نعيم زياد", "فايز محمد فايز الرثوم",
                    "قصي عمر نظام السكافي", "كايد نور الدين هاشم الخلايله", "كرم محمود خضر موسى",
                    "ماجد ابراهيم ماجد ابوجحيشه", "محمد احمد ذيب الباز", "محمد احمد عايد الدغيمات",
                    "محمد علاء محمد جويحان", "محمد علي موسى فلاح", "محمد معتصم محمد الدغيمات",
                    "مصطفى محمد موسى ابو حديد", "موسى عبد المالك جاسم", "نسيم هاني احمد عدوان", "وسام معاذ محمد الدغيمات",
                    "ياسين احمد عبد اللطيف العويدات", "يامن جلال احمد خليفه", "ينال أنس محمود الهنيدي"
                ]
            },
            "الصف الخامس": {
                "5أ": [
                    "ابراهيم اسامه ابراهيم ناصر", "احمد خليف احمد الاحمد", "احمد طالب محمد محمود",
                    "احمد محمود احمد سالم", "احمد نصر ابراهيم ابريوش", "المعتز بالله علاء الدين علي علي",
                    "امير فراس فواز سليمان", "امين مصطفى محمد عبد الرحمن الشرافي", "انس خليل سلمان الخلايله",
                    "اوس احمد فوزي ياسين", "اوس عيسى ماجد أبو جحيشه", "زياد محمد فايز ابو جحيشه", "زيد اكثم يوسف الحياري", "سعيد محمد سعيد الحلحولي", "صدام عز الدين احمد الخلايله",
                    "صدام ياسر احمد أبو حواس", "ضياء ايمن عزت الصغير", "عباده فراس علي الكباريتي", "عبد الكريم مؤمن عارف جرادات",
                    "عبد الله محمد حسن نصر", "عبد الله محمد فلاح الصليبي", "عبدالحي امين جمعه عصيري", "عريب أنس موسى أبو سعود", "عمر إبراهيم محمد عبد الله",
                    "محمد ابراهيم فايز ابو جحيشه", "محمد احمد بشير المصري", "محمد اديب يوسف مطلق",
                    "محمد حمزة عبد الكريم الخلايلة", "محمد رجب حامد المشاعله", "محمد ياسر جمعه العلي",
                    "مصطفى حمزة جمعه جبر", "معتز عمر علي السليم"
                ],
                "5ب": [
                    "احمد بلال احمد الخلايله", "احمد محمد جمعة العلي", "احمد نايف عمر الجاسم",
                    "امير ثائر حماد خليل", "اوس خالد عبد الكريم الخطيب", "براء علي عبد الحفيظ الرحايله", "حبيب الرحمن خالد محمد الخلايله", "حسين عبد الهادي الطرمه", "خليل إبراهيم خليل العش",
                    "رسول نضال بسام حسونه", "ريان احمد يخلف الخلايله", "عادل عبد الله محمد الحراحشه", "عبيدة فادي سليمان فلاح", "عمار قاهر صبحي السيد", "فايز فواز عبد الحليم الخلايله", "قصي ثائر نضال أبو كتب", "محمد احمد عبد الله غيضان", "محمد احمد محمد بشير الغلبان", "محمد خالد ماجد مصطفى", "محمد رعد خالد ابو كوش", "محمد سعد محمد مسعد", "محمد محمود محمد الخلايله", "محمد محمود محمد خليفة", "محمد وسام عزان ابو الحج", "محمد وسام محمود عبد الرازق", "مصعب نافع احمد الخلايلة",
                    "معاذ محمود سلامة المصري", "ياسين علي موسى عبد الحميد", "يحيى صلاح جاهين موسى", "يوسف مصطفى جمعه جبر"
                ],
                "5ج": [
                    "احمد بدر عيسى الدغيمات", "احمد رامي حسين الكريم", "احمد سالم فاروق العشيبات", "احمد محمد كامل الخلايله", "اسيد محمود عمر أبو دية", "اليمان محمد صابر صالح", "امير مهند محمد الصوالحي", "ايهم محمد خالد القرعان", "جواد قاسم محمد الخزاعلة", "سفيان بكر عبد الباسط الخلايلة", "عبد الكريم محمد عبد اللطيف الجاسم", "عبد الله عارف محمد محمود", "عبد الهادي محمد موسى جاسم المحمد", "علاء محمود خالد عبد الله", "علي جهاد علي شريم", "علي محمد موسى فلاح", "عمر إبراهيم محمد عبد الله", "عمر حذيفه فؤاد حسين", "عمر عبد الحكيم ابراهيم الزيدان", "عمروليد درويش شلتاوي", "كنان عبدالله جمعه الشعيري", "محمد اشرف عبد الفتاح الحلحولي", "محمد فراس فوزي أبو صباح", "محمد ماهر توفيق يوسف", "محمد مصطفى محمد الصوالحي", "مشاري احمد محمود الزيود", "يامن محمود ناصر أبو زر", "يحيى سالم احمد ابو سعيفان", "يزن جابر فوزي الاحمد", "يزن رضوان محمود الخلايله", "يمان انس موسى الكاكوني"
                ],
                "5د": [
                    "ابراهيم حسين ابراهيم الفواعير", "احمد فراس محمد سلامه", "ادم توفيق عبد اللطيف العليمي", "الياس طاهر يوسف اسعد", "امير سعيد محمد الفقعاوي", "امير كمال محمد ناصر", "تيم احمد عبد الرزاق براهمه", "جميل سامر جميل الدراغمه", "جود تامر محمد البطران", "حسين حسن ابراهيم المناصير", "خالد احمد خالد الاسمر", "رائد رمزي احمد الخلايله", "زكريا مصطفى احمد الحياري", "زيد عامرعلي السليم", "زيد عبد الفتاح ماجد ابو جحيشة", "سيف الدين مهند جمعه الحديدي", "صالح ابراهيم سعيد خليل", "عبد اللطيف عمر عبد اللطيف الخلايله", "عبيده يوسف عبد اللطيف الخلايله", "عدنان عيسى عدنان الاسمر", "علي عمر عبدالله المومني", "عماد محمد محمود الخزاعلة", "عمير علاء صالح هندي", "فادي محمود محارب النجار", "محمد احمد عقاب الاسعد", "محمد احمد ماجد الجرادات", "محمد بلال محمد العليمات", "محمد مهند احمد السليمه", "مهند فريد محمد صباح", "وليد حسين ابراهيم الفواعير"
                ],
                "5هـ": [
                    "أحمد خلف بركات الزيود", "أحمد محمد علي حسن", "أركان عمر غالب قدح", "أمير مجدي محمود صلاح", "إسلام محمد جميل البشايرة", "امير جلال صدقي قطيفان", "انس زكري إبراهيم حداد", "خالد محمد صابر غباين", "دانيال رسمي سليمان الغباينه", "رأفت باسم تميم سلهب", "سليمان فراس محمد نجيب عبدالله", "سند أحمد حسن عليمات", "صهيب عثمان ضيف الله الخلايلة", "عامر معاذ فؤاد حسين", "عبد الرحمن رعد احمد الدغيمات", "عبد الكريم عاصم عبد الحفيظ المفلح", "عبدالرحمن محمد أحمد أبو ريان", "عبدالرحمن محمد رأفت أبو عشيبة", "عبدالرحمن محمود محمد الجابري", "عبدالوهاب إياد عبدالوهاب أصفر", "علي عطا الله طه عواد", "عمر أحمد إبراهيم المصري", "عمر عبدالعزيز عمر دردس", "عمر عمر محمد أبو طعيمه", "فيصل علاء فيصل الحياصات", "مالك يوسف علي الفلاح", "محمد أحمد عبدالعزيز قاسم", "محمد إبراهيم مفلح الخلايلة", "محمد ايمن احمد حماد", "محمد مصطفى يعقوب حمدان", "مراد جهاد عبدالحافظ الخلايلة"
                ]
            }
        };

        // تفاصيل الطلاب
        const studentDetails = {
            "احمد حمزة موسى فلاح": { 
                nationalId: "2002074695", 
                phone1: "780333809", 
                phone2: "780303201", 
                absences9: "15/9, 23/9, 24/9, 29/9", 
                totalAbsences9: 4, 
                absences10: "15/10", 
                totalAbsences10: 1,
                reportedDate: "9/10/2025" 
            },
            "احمد سمير عبد الله احمد": { 
                nationalId: "2001423895", 
                phone1: "799489127", 
                phone2: "781329492", 
                absences9: "10/9, 22/9, 25/9", 
                totalAbsences9: 3, 
                absences10: "5/10, 9/10, 15/10, 21/10, 26/10", 
                totalAbsences10: 5,
                reportedDate: "9/10/2025" 
            },
            "احمد فواز عبدالهادي الخلايلة": { 
                nationalId: "2002183693", 
                phone1: "798870798", 
                phone2: "796376504", 
                absences9: "23/9", 
                totalAbsences9: 1, 
                absences10: "2/10, 15/10, 23/10", 
                totalAbsences10: 3,
                reportedDate: "9/10/2025" 
            },
            "ايهم علي موسى الحجوج": { 
                nationalId: "", 
                phone1: "", 
                phone2: "", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "لا يوجد غياب", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "باسل مراد عبدالحافظ الخلايلة": { 
                nationalId: "2002137677", 
                phone1: "789166332", 
                phone2: "772530768", 
                absences9: "25/9, 29/9", 
                totalAbsences9: 2, 
                absences10: "2/10", 
                totalAbsences10: 1,
                reportedDate: "9/10/2025" 
            },
            "حاتم مؤيد ناجي الحنتولي": { 
                nationalId: "2002112033", 
                phone1: "796211046", 
                phone2: "", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "19/10, 21/10, 22/10, 23/10", 
                totalAbsences10: 4,
                reportedDate: "9/10/2025" 
            },
            "حمزه سمير محمود سليمان": { 
                nationalId: "2002113731", 
                phone1: "780399015", 
                phone2: "788823011", 
                absences9: "25/9", 
                totalAbsences9: 1, 
                absences10: "2/10, 7/10, 15/10, 20/10, 23/10", 
                totalAbsences10: 5,
                reportedDate: "9/10/2025" 
            },
            "حمزه محمد شحاده اذهيبه": { 
                nationalId: "2002242614", 
                phone1: "790786850", 
                phone2: "790120299", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "لا يوجد غياب", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "خليفه ابراهيم حسني خليفه": { 
                nationalId: "2002001421", 
                phone1: "", 
                phone2: "", 
                absences9: "9/9, 10/9, 11/9, 14/9, 18/9, 21/9, 22/9, 23/9, 24/9, 25/9, 28/9, 29/9, 30/9", 
                totalAbsences9: 13, 
                absences10: "1/10, 2/10, 5/10, 6/10, 7/10, 8/10, 9/10, 12/10, 13/10, 14/10, 15/10, 16/10, 19/10, 20/10, 21/10, 22/10, 23/10, 26/10, 27/10, 28/10", 
                totalAbsences10: 20,
                reportedDate: "9/10/2025" 
            },
            "ريان حاتم عناد العيسى": { 
                nationalId: "2002183583", 
                phone1: "", 
                phone2: "", 
                absences9: "11/9", 
                totalAbsences9: 1, 
                absences10: "2/10, 15/10, 20/10, 23/10", 
                totalAbsences10: 4,
                reportedDate: "9/10/2025" 
            },
            "ريان عبد الكريم خلف ابو هزيم": { 
                nationalId: "2002152751", 
                phone1: "", 
                phone2: "", 
                absences9: "15/9, 23/9, 25/9", 
                totalAbsences9: 3, 
                absences10: "2/10, 20/10, 26/10", 
                totalAbsences10: 3,
                reportedDate: "9/10/2025" 
            },
            "عادل جمال عبد المنعم ابداح": { 
                nationalId: "2001824216", 
                phone1: "796278180", 
                phone2: "778249578", 
                absences9: "18/9, 22/9, 25/9", 
                totalAbsences9: 3, 
                absences10: "2/10, 9/10, 14/10, 19/10, 20/10, 21/10, 23/10, 26/10", 
                totalAbsences10: 8,
                reportedDate: "9/10/2025" 
            },
            "عبد الله احمد كامل الخلايلة": { 
                nationalId: "2002128113", 
                phone1: "785617041", 
                phone2: "", 
                absences9: "11/9, 29/9", 
                totalAbsences9: 2, 
                absences10: "13/10, 19/10", 
                totalAbsences10: 2,
                reportedDate: "9/10/2025" 
            },
            "عبدالله خلدون محمد الخلايله": { 
                nationalId: "2002133569", 
                phone1: "785210060", 
                phone2: "780261644", 
                absences9: "15/9, 30/9", 
                totalAbsences9: 2, 
                absences10: "20/10", 
                totalAbsences10: 1,
                reportedDate: "9/10/2025" 
            },
            "علي عصام سلمان الخلايلة": { 
                nationalId: "", 
                phone1: "", 
                phone2: "", 
                absences9: "11/9, 18/9, 24/9, 28/9", 
                totalAbsences9: 4, 
                absences10: "1/10, 2/10, 6/10, 7/10, 8/10, 9/10, 12/10, 13/10, 14/10, 15/10, 16/10, 19/10, 20/10, 22/10, 23/10, 26/10, 27/10, 28/10", 
                totalAbsences10: 18,
                reportedDate: "9/10/2025" 
            },
            "علي فراس علي الكباريتي": { 
                nationalId: "2001752818", 
                phone1: "", 
                phone2: "", 
                absences9: "9/9, 11/9, 14/9, 16/9, 25/9, 29/9, 30/9", 
                totalAbsences9: 7, 
                absences10: "1/10, 9/10, 14/10, 22/10, 23/10, 28/10", 
                totalAbsences10: 6,
                reportedDate: "9/10/2025" 
            },
            "عمر احمد جابر احمد": { 
                nationalId: "2002255013", 
                phone1: "788178492", 
                phone2: "", 
                absences9: "11/9, 22/9, 29/9", 
                totalAbsences9: 3, 
                absences10: "2/10, 7/10, 15/10, 16/10, 26/10", 
                totalAbsences10: 5,
                reportedDate: "9/10/2025" 
            },
            "عمر خالد حسين الفارغه": { 
                nationalId: "2002033121", 
                phone1: "795924482", 
                phone2: "", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "2/10, 19/10, 26/10", 
                totalAbsences10: 3,
                reportedDate: "9/10/2025" 
            },
            "عمر غسان حسن حموه": { 
                nationalId: "2002228602", 
                phone1: "792924985", 
                phone2: "788304001", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "لا يوجد غياب", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "عمر محمد عبد الرحيم الخلايله": { 
                nationalId: "2002114189", 
                phone1: "790741474", 
                phone2: "789299055", 
                absences9: "14/9, 15/9, 29/9", 
                totalAbsences9: 3, 
                absences10: "2/10, 5/10, 6/10, 19/10, 20/10", 
                totalAbsences10: 5,
                reportedDate: "9/10/2025" 
            },
            "قيس خليل محمد اطفيحه": { 
                nationalId: "2002184632", 
                phone1: "799425570", 
                phone2: "799597530", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "لا يوجد غياب", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "قيس يحيى عطيه درويش": { 
                nationalId: "2002038772", 
                phone1: "790480235", 
                phone2: "795758104", 
                absences9: "10/9", 
                totalAbsences9: 1, 
                absences10: "20/10", 
                totalAbsences10: 1,
                reportedDate: "9/10/2025" 
            },
            "كريم محمد مصطفى الرافعي": { 
                nationalId: "2001649340", 
                phone1: "", 
                phone2: "", 
                absences9: "9/9, 10/9, 11/9, 14/9, 15/9, 18/9, 23/9, 24/9, 25/9, 29/9, 30/9", 
                totalAbsences9: 11, 
                absences10: "1/10, 2/10, 5/10, 6/10, 7/10, 8/10, 9/10, 12/10, 13/10, 14/10, 15/10, 16/10, 19/10, 20/10, 21/10, 22/10, 23/10, 26/10, 27/10, 28/10", 
                totalAbsences10: 20,
                reportedDate: "9/10/2025" 
            },
            "مؤيد ماجد إبراهيم القزق": { 
                nationalId: "", 
                phone1: "", 
                phone2: "", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "2/10", 
                totalAbsences10: 1,
                reportedDate: "9/10/2025" 
            },
            "محمد عدنان حسين النفيعات": { 
                nationalId: "", 
                phone1: "", 
                phone2: "", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "1/10, 2/10, 6/10, 7/10, 13/10, 15/10, 21/10, 22/10, 23/10", 
                totalAbsences10: 9,
                reportedDate: "9/10/2025" 
            },
            "محمود ابراهيم خلف ابوهزيم": { 
                nationalId: "2001746880", 
                phone1: "", 
                phone2: "", 
                absences9: "9/9, 10/9, 14/9, 15/9, 21/9, 25/9, 29/9", 
                totalAbsences9: 7, 
                absences10: "1/10, 15/10, 26/10", 
                totalAbsences10: 3,
                reportedDate: "9/10/2025" 
            },
            "محمود عبدالحميد محمد عياش": { 
                nationalId: "2002227664", 
                phone1: "789291974", 
                phone2: "785414094", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "7/10, 22/10", 
                totalAbsences10: 2,
                reportedDate: "9/10/2025" 
            },
            "مشعل وليد حميده عفانه": { 
                nationalId: "2002229972", 
                phone1: "788491439", 
                phone2: "", 
                absences9: "11/9, 15/9, 23/9, 25/9", 
                totalAbsences9: 4, 
                absences10: "14/10, 21/10, 28/10", 
                totalAbsences10: 3,
                reportedDate: "9/10/2025" 
            },
            "مصطفى محمد محمود حماد": { 
                nationalId: "", 
                phone1: "", 
                phone2: "", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "2/10", 
                totalAbsences10: 1,
                reportedDate: "9/10/2025" 
            },
            "معتز احمد سالم المزايده": { 
                nationalId: "2002180240", 
                phone1: "788255388", 
                phone2: "", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "لا يوجد غياب", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "وديع بلال عادل ابوالسعود": { 
                nationalId: "2002177400", 
                phone1: "785219099", 
                phone2: "788639437", 
                absences9: "25/9", 
                totalAbsences9: 1, 
                absences10: "1/10, 19/10", 
                totalAbsences10: 2,
                reportedDate: "9/10/2025" 
            },
            "وسيم فواز عبد الحليم الخلايله": { 
                nationalId: "2002165348", 
                phone1: "772965267", 
                phone2: "796384962", 
                absences9: "9/9, 25/9", 
                totalAbsences9: 2, 
                absences10: "8/10, 16/10, 23/10", 
                totalAbsences10: 3,
                reportedDate: "9/10/2025" 
            },
            "ياسين عمر عبد الرحمن الحياري": { 
                nationalId: "2002135796", 
                phone1: "780990117", 
                phone2: "772675365", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "1/10, 27/10", 
                totalAbsences10: 2,
                reportedDate: "9/10/2025" 
            },
            "يامن فيصل محمد ابو الرب": { 
                nationalId: "2002121197", 
                phone1: "", 
                phone2: "", 
                absences9: "25/9", 
                totalAbsences9: 1, 
                absences10: "1/10, 2/10, 5/10, 15/10, 16/10, 19/10, 21/10, 23/10, 26/10, 27/10, 28/10", 
                totalAbsences10: 11,
                reportedDate: "9/10/2025" 
            },
            "يزن عزيز رياض العربي": { 
                nationalId: "", 
                phone1: "", 
                phone2: "", 
                absences9: "10/9, 11/9, 14/9, 18/9, 23/9, 24/9, 25/9, 28/9, 30/9", 
                totalAbsences9: 9, 
                absences10: "1/10, 2/10, 5/10, 6/10, 7/10, 8/10, 9/10, 12/10, 13/10, 14/10, 15/10, 16/10, 19/10, 20/10, 21/10, 22/10, 23/10, 26/10, 27/10, 28/10", 
                totalAbsences10: 20,
                reportedDate: "9/10/2025" 
            },
            "يمان محمد فتحي عوده": { 
                nationalId: "2002102364", 
                phone1: "", 
                phone2: "", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "15/10, 20/10, 21/10, 23/10, 26/10", 
                totalAbsences10: 5,
                reportedDate: "9/10/2025" 
            },
            "يوسف محمد موسى فلاح": { 
                nationalId: "", 
                phone1: "", 
                phone2: "", 
                absences9: "9/9, 15/9, 18/9, 25/9, 29/9", 
                totalAbsences9: 5, 
                absences10: "15/10, 20/10", 
                totalAbsences10: 2,
                reportedDate: "9/10/2025" 
            },
            "اسامه باسم تميم سلهب": { 
                nationalId: "2002052459", 
                phone1: "788945132", 
                phone2: "", 
                absences9: "7/9, 10/9", 
                totalAbsences9: 2, 
                absences10: "لا يوجد غياب", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "الياس رامي عيد ابو جاد الله": { 
                nationalId: "2002208158", 
                phone1: "788495077", 
                phone2: "", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "15/10, 20/10", 
                totalAbsences10: 2,
                reportedDate: "9/10/2025" 
            },
            "امير حمزة سالم ارشيدات": { 
                nationalId: "2002186868", 
                phone1: "775439195", 
                phone2: "788468615", 
                absences9: "9/9, 10/9, 11/9, 14/9", 
                totalAbsences9: 4, 
                absences10: "2/10, 13/10, 15/10, 19/10, 21/10, 23/10", 
                totalAbsences10: 6,
                reportedDate: "9/10/2025" 
            },
            "انس محمود عبد الرؤوف صوص": { 
                nationalId: "2002050633", 
                phone1: "782331024", 
                phone2: "788218682", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "15/10, 19/10, 23/10", 
                totalAbsences10: 3,
                reportedDate: "9/10/2025" 
            },
            "ايهم انس محمود الهندي": { 
                nationalId: "2002089819", 
                phone1: "799098399", 
                phone2: "", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "21/10", 
                totalAbsences10: 1,
                reportedDate: "9/10/2025" 
            },
            "ايهم يحيى بدوى الغرابلي": { 
                nationalId: "2002091540", 
                phone1: "785801868", 
                phone2: "786381561", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "لا يوجد غياب", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "بكر محمد نمر طلوزي": { 
                nationalId: "", 
                phone1: "", 
                phone2: "", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "15/10, 16/10, 23/10", 
                totalAbsences10: 3,
                reportedDate: "9/10/2025" 
            },
            "حاتم طارق حاكم العليوات": { 
                nationalId: "2002253384", 
                phone1: "786071994", 
                phone2: "782711372", 
                absences9: "10/9, 15/9, 22/9, 24/9, 28/9", 
                totalAbsences9: 5, 
                absences10: "1/10, 5/10, 8/10, 9/10, 13/10, 15/10, 16/10, 20/10, 21/10, 22/10, 23/10", 
                totalAbsences10: 11,
                reportedDate: "9/10/2025" 
            },
            "حسن حامد حسن ابو صره": { 
                nationalId: "2002184530", 
                phone1: "776458881", 
                phone2: "780845590", 
                absences9: "15/9", 
                totalAbsences9: 1, 
                absences10: "7/10, 15/10", 
                totalAbsences10: 2,
                reportedDate: "9/10/2025" 
            },
            "خليل ثابت زهدي ثابت": { 
                nationalId: "", 
                phone1: "", 
                phone2: "", 
                absences9: "9/9, 15/9", 
                totalAbsences9: 2, 
                absences10: "16/10, 23/10", 
                totalAbsences10: 2,
                reportedDate: "9/10/2025" 
            },
            "راشد عدنان عيسى الدغيمات": { 
                nationalId: "", 
                phone1: "", 
                phone2: "", 
                absences9: "11/9", 
                totalAbsences9: 1, 
                absences10: "15/10, 22/10, 23/10", 
                totalAbsences10: 3,
                reportedDate: "9/10/2025" 
            },
            "ريان باسم عبد اللطيف جلغوم": { 
                nationalId: "2002108692", 
                phone1: "788209296", 
                phone2: "", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "20/10, 28/10", 
                totalAbsences10: 2,
                reportedDate: "9/10/2025" 
            },
            "زيد حسان وجيه سلمان": { 
                nationalId: "2002226474", 
                phone1: "797001621", 
                phone2: "", 
                absences9: "24/9, 28/9", 
                totalAbsences9: 2, 
                absences10: "1/10, 7/10, 8/10, 13/10, 14/10, 15/10, 19/10, 20/10, 21/10, 22/10, 23/10, 26/10, 27/10, 28/10", 
                totalAbsences10: 14,
                reportedDate: "9/10/2025" 
            },
            "زيد محمود سالم ابو طراد": { 
                nationalId: "2002087360", 
                phone1: "790311547", 
                phone2: "789918009", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "2/10, 15/10, 26/10", 
                totalAbsences10: 3,
                reportedDate: "9/10/2025" 
            },
            "زيد معتز فؤاد جبريل": { 
                nationalId: "2002102655", 
                phone1: "788420122", 
                phone2: "788420122", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "20/10", 
                totalAbsences10: 1,
                reportedDate: "9/10/2025" 
            },
            "زيد نورالدين محمد الخلايله": { 
                nationalId: "2001946160", 
                phone1: "789856683", 
                phone2: "", 
                absences9: "10/9, 29/9", 
                totalAbsences9: 2, 
                absences10: "23/10", 
                totalAbsences10: 1,
                reportedDate: "9/10/2025" 
            },
            "سلطان محمد احمد السيد احمد": { 
                nationalId: "2002256747", 
                phone1: "796464790", 
                phone2: "788831187", 
                absences9: "28/9", 
                totalAbsences9: 1, 
                absences10: "23/10", 
                totalAbsences10: 1,
                reportedDate: "9/10/2025" 
            },
            "صالح محمد علي الشوره": { 
                nationalId: "2002241916", 
                phone1: "772232619", 
                phone2: "", 
                absences9: "7/9, 16/9", 
                totalAbsences9: 2, 
                absences10: "22/10", 
                totalAbsences10: 1,
                reportedDate: "9/10/2025" 
            },
            "طارق شوقي يوسف الحسن": { 
                nationalId: "2002157049", 
                phone1: "780111941", 
                phone2: "7955115717", 
                absences9: "9/9", 
                totalAbsences9: 1, 
                absences10: "15/10, 20/10", 
                totalAbsences10: 2,
                reportedDate: "9/10/2025" 
            },
            "عباده عبدالحميد مصباح الجابر": { 
                nationalId: "2002146738", 
                phone1: "788494452", 
                phone2: "792342224", 
                absences9: "9/9, 14/9, 15/9, 28/9, 29/9", 
                totalAbsences9: 5, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "عبد الرحمن مؤمن عارف جرادات": { 
                nationalId: "2002170540", 
                phone1: "786721722", 
                phone2: "788639547", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "عبد الرحمن هاشم محمد الخلايله": { 
                nationalId: "", 
                phone1: "", 
                phone2: "", 
                absences9: "11/9", 
                totalAbsences9: 1, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "عبد الله سليمان يوسف الشملة": { 
                nationalId: "200201446", 
                phone1: "788821614", 
                phone2: "", 
                absences9: "9/9", 
                totalAbsences9: 1, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "عبد الله محمد عبد الله المومني": { 
                nationalId: "2001915211", 
                phone1: "776530834", 
                phone2: "770782650", 
                absences9: "16/9, 28/9", 
                totalAbsences9: 2, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "عبد الهادي سامر عواد ابو هزيم": { 
                nationalId: "2002078635", 
                phone1: "789334438", 
                phone2: "788194204", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "عمر اشرف محمد محمد": { 
                nationalId: "2002172538", 
                phone1: "781330702", 
                phone2: "", 
                absences9: "18/9, 24/9", 
                totalAbsences9: 2, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "غسان ايمن احمد القلالوه": { 
                nationalId: "9000556742", 
                phone1: "788706893", 
                phone2: "781218268", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "ليث حسام حسن حسن": { 
                nationalId: "2002091706", 
                phone1: "787244582", 
                phone2: "789187995", 
                absences9: "10/9", 
                totalAbsences9: 1, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "محمد اسماعيل مصطفى اسماعيل": { 
                nationalId: "2002193848", 
                phone1: "796735668", 
                phone2: "796936708", 
                absences9: "28/9", 
                totalAbsences9: 1, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "محمد باسم عبد اللطيف جلغوم": { 
                nationalId: "2002108698", 
                phone1: "788201296", 
                phone2: "", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "محمد ماجد احمد يوسف": { 
                nationalId: "2002210270", 
                phone1: "781218566", 
                phone2: "789018940", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "محمد محمود احمد محمود": { 
                nationalId: "2002235553", 
                phone1: "785207717", 
                phone2: "791310588", 
                absences9: "11/9, 24/9", 
                totalAbsences9: 2, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "محمد ياسين سامي ابراهيم": { 
                nationalId: "2002053729", 
                phone1: "782928050", 
                phone2: "", 
                absences9: "9/9, 11/9", 
                totalAbsences9: 2, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "نبيل سمير محمد عواد": { 
                nationalId: "2002220176", 
                phone1: "", 
                phone2: "", 
                absences9: "25/9", 
                totalAbsences9: 1, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "نسيم مهند محمد ابو السعود": { 
                nationalId: "2002181519", 
                phone1: "788228194", 
                phone2: "781474455", 
                absences9: "7/9, 16/9", 
                totalAbsences9: 2, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "همام معاذ ضيف الله الخلايله": { 
                nationalId: "", 
                phone1: "", 
                phone2: "", 
                absences9: "11/9, 16/9, 18/9, 29/9", 
                totalAbsences9: 4, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "يوسف محمد محمود الزيود": { 
                nationalId: "2002226661", 
                phone1: "788717388", 
                phone2: "780138871", 
                absences9: "7/9, 14/9, 15/9, 28/9, 29/9", 
                totalAbsences9: 5, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            },
            "احمد صالح احمد الخلايلة": { 
                nationalId: "2002113259", 
                phone1: "788510128", 
                phone2: "777420933", 
                absences9: "", 
                totalAbsences9: 0, 
                absences10: "", 
                totalAbsences10: 0,
                reportedDate: "9/10/2025" 
            }
        };

        // تهيئة التخزين المحلي
        let studentActions = JSON.parse(localStorage.getItem('studentActions')) || {};
        let studentInfo = JSON.parse(localStorage.getItem('studentInfo')) || {};
        let studentAbsences = JSON.parse(localStorage.getItem('studentAbsences')) || {};
        let dailyAbsences = JSON.parse(localStorage.getItem('dailyAbsences')) || {};
        let currentStudent = null;
        let currentUserType = null; // 'limited' أو 'full'
        let emergencyMode = false;
        let selectedStudents = new Set();
        let emergencyAudio = null;

        // عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DOM Loaded. Initializing app...");
            // إخفاء رسالة التحميل الأولية
            document.getElementById('initialLoading').style.display = 'none';
            checkLoginStatus();
            
            // إعداد مستمعي أحداث التحقق من كلمة المرور
            setupPasswordValidation();
        });

        // التحقق من حالة تسجيل الدخول
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            const userType = localStorage.getItem('userType');
            
            if (isLoggedIn && userType) {
                console.log("User is logged in. Showing main page.");
                currentUserType = userType;
                showMainPage();
            } else {
                console.log("User is not logged in. Showing login page.");
                showLoginPage();
            }
        }

        // عرض صفحة تسجيل الدخول
        function showLoginPage() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('mainPage').style.display = 'none';
            document.getElementById('studentPage').style.display = 'none';
            document.getElementById('highAbsencePage').style.display = 'none';
            document.getElementById('reportsPage').style.display = 'none';
            document.getElementById('schoolAbsencePage').style.display = 'none';
        }

        // عرض الصفحة الرئيسية
        function showMainPage() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('mainPage').style.display = 'block';
            document.getElementById('studentPage').style.display = 'none';
            document.getElementById('highAbsencePage').style.display = 'none';
            document.getElementById('reportsPage').style.display = 'none';
            document.getElementById('schoolAbsencePage').style.display = 'none';
            
            // عرض/إخفاء الميزات حسب نوع المستخدم
            if (currentUserType === 'limited') {
                // المستخدم المحدود يمكنه فقط تسجيل الغياب
                document.getElementById('reportsBtn').style.display = 'none';
                document.getElementById('highAbsenceBtn').style.display = 'none';
                document.getElementById('addStudentBtn').style.display = 'none';
                document.getElementById('settingsBtn').style.display = 'none';
                document.getElementById('schoolAbsenceBtn').style.display = 'none';
            } else if (currentUserType === 'full') {
                // المستخدم صاحب الصلاحيات الكاملة
                document.getElementById('reportsBtn').style.display = 'inline-block';
                document.getElementById('highAbsenceBtn').style.display = 'inline-block';
                document.getElementById('addStudentBtn').style.display = 'inline-block';
                document.getElementById('settingsBtn').style.display = 'inline-block';
                document.getElementById('schoolAbsenceBtn').style.display = 'inline-block';
            }
            
            initializeApp();
            updateStats();
        }

        // التحقق من كلمة المرور
        function checkPassword() {
            const password = document.getElementById('passwordInput').value;
            const errorMessage = document.getElementById('errorMessage');
            
            if (password === '123456') {
                // مستخدم محدود
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('userType', 'limited');
                currentUserType = 'limited';
                showMainPage();
            } else if (password === '110527') {
                // مستخدم صاحب صلاحيات كاملة
                localStorage.setItem('isLoggedIn', 'true');
                localStorage.setItem('userType', 'full');
                currentUserType = 'full';
                showMainPage();
            } else {
                errorMessage.style.display = 'block';
                document.getElementById('passwordInput').value = '';
                setTimeout(() => { errorMessage.style.display = 'none'; }, 3000);
            }
        }

        // تسجيل الخروج
        function logout() {
            localStorage.setItem('isLoggedIn', 'false');
            localStorage.removeItem('userType');
            currentUserType = null;
            showLoginPage();
        }

        // الاستماع لمفتاح Enter في حقل كلمة المرور
        document.getElementById('passwordInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                checkPassword();
            }
        });

        // تهيئة التطبيق
        function initializeApp() {
            createClassTabs();
        }

        // إنشاء تبويبات الصفوف
        function createClassTabs() {
            const tabsContainer = document.getElementById('classTabs');
            const contentContainer = document.getElementById('classTabContent');
            
            tabsContainer.innerHTML = '';
            contentContainer.innerHTML = '';
            
            let firstTab = true;
            let tabIndex = 0;
            
            Object.keys(studentsData).forEach(grade => {
                Object.keys(studentsData[grade]).forEach(className => {
                    const tabId = `tab-${tabIndex}`;
                    
                    // إنشاء التبويب
                    const tabItem = document.createElement('li');
                    tabItem.className = 'nav-item';
                    tabItem.innerHTML = `<a class="nav-link ${firstTab ? 'active' : ''}" data-bs-toggle="tab" href="#${tabId}">${className}</a>`;
                    tabsContainer.appendChild(tabItem);
                    
                    // إنشاء محتوى التبويب
                    const tabContent = document.createElement('div');
                    tabContent.className = `tab-pane fade ${firstTab ? 'show active' : ''}`;
                    tabContent.id = tabId;
                    
                    const studentsGrid = document.createElement('div');
                    studentsGrid.className = 'row';
                    
                    studentsData[grade][className].forEach(studentName => {
                        const studentCard = createStudentCard(studentName, className);
                        studentsGrid.appendChild(studentCard);
                    });
                    
                    tabContent.appendChild(studentsGrid);
                    contentContainer.appendChild(tabContent);
                    
                    firstTab = false;
                    tabIndex++;
                });
            });
        }

        // إنشاء بطاقة الطالب - تم إصلاح المشكلة هنا
        function createStudentCard(studentName, className) {
            const col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4 mb-3';
            
            const card = document.createElement('div');
            card.className = 'student-card';
            
            // تعديل معالج النقر للبطاقة
            card.onclick = function(e) {
                // التأكد من أن النقر ليس على الزر
                if (e.target.classList.contains('mark-absence-btn')) {
                    return; // لا تفعل شيئًا عند النقر على الزر
                }
                
                if (currentUserType === 'limited') {
                    // لا تفعل شيئًا للمستخدم المحدود
                    return;
                } else {
                    openStudentPage(studentName, className);
                }
            };
            
            const details = studentDetails[studentName] || {};
            const totalAbsences = (details.totalAbsences9 || 0) + (details.totalAbsences10 || 0);
            const absenceInfo = totalAbsences > 0 ? 
                `<div class="mt-2 text-danger"><i class="fas fa-exclamation-circle"></i> غيابات: ${totalAbsences}</div>` : '';
            
            const absenceBtnHtml = currentUserType === 'limited' ? 
                `<button class="mark-absence-btn" onclick="markSingleAbsence('${studentName}', '${className}', event)">
                    <i class="fas fa-calendar-times"></i> تسجيل غياب
                </button>` : '';
            
            card.innerHTML = `
                <div class="student-name">
                    <span>${studentName}</span>
                    ${totalAbsences > 0 ? '<span class="absence-indicator">غياب</span>' : ''}
                </div>
                <div class="student-class">الصف: ${className}</div>
                ${absenceInfo}
                ${absenceBtnHtml}
            `;
            
            col.appendChild(card);
            return col;
        }

        // تعديل دالة تسجيل الغياب للطالب الواحد - تم إصلاح المشكلة هنا
        function markSingleAbsence(studentName, className, event) {
            // منع انتقال الحدث إذا تم تمريره
            if (event) {
                event.stopPropagation();
            }
            
            // إنشاء نافذة منبثقة لتحديد التاريخ
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.id = 'absenceDateModal';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">تسجيل غياب الطالب</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label for="absenceDate" class="form-label">تاريخ الغياب</label>
                                <input type="date" class="form-control" id="absenceDate" value="${new Date().toISOString().split('T')[0]}">
                            </div>
                            <div class="mb-3">
                                <label for="absenceReason" class="form-label">سبب الغياب (اختياري)</label>
                                <textarea class="form-control" id="absenceReason" rows="3" placeholder="أدخل سبب الغياب هنا..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                            <button type="button" class="btn btn-primary" onclick="confirmAbsence('${studentName}', '${className}')">تأكيد</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            const bootstrapModal = new bootstrap.Modal(modal);
            bootstrapModal.show();
            
            // إزالة النافذة من DOM عند الإغلاق
            modal.addEventListener('hidden.bs.modal', function () {
                document.body.removeChild(modal);
            });
        }

        // دالة جديدة لتأكيد تسجيل الغياب
        function confirmAbsence(studentName, className) {
            const dateInput = document.getElementById('absenceDate');
            const reasonInput = document.getElementById('absenceReason');
            
            if (!dateInput.value) {
                showToast('الرجاء تحديد تاريخ الغياب', 'warning');
                return;
            }
            
            const selectedDate = new Date(dateInput.value);
            const dateKey = selectedDate.toISOString().split('T')[0];
            const formattedDate = `${selectedDate.getDate()}/${selectedDate.getMonth() + 1}`;
            const reason = reasonInput.value || 'غياب مسجل بواسطة النظام';
            
            // التحقق من وجود غياب مسجل لهذا الطالب في نفس اليوم
            if (!dailyAbsences[dateKey]) {
                dailyAbsences[dateKey] = {};
            }
            
            if (dailyAbsences[dateKey][studentName]) {
                showToast(`الطالب ${studentName} مسجل غيابه بالفعل في هذا التاريخ`, 'warning');
                return;
            }
            
            // تسجيل الغياب
            const absenceId = `absence-${Date.now()}-${Math.random()}`;
            const absence = {
                id: absenceId,
                date: formattedDate,
                fullDate: dateInput.value,
                reason: reason,
                className: className,
                grade: getCurrentGrade(studentName)
            };
            
            if (!studentAbsences[studentName]) {
                studentAbsences[studentName] = [];
            }
            
            studentAbsences[studentName].push(absence);
            dailyAbsences[dateKey][studentName] = true;
            
            localStorage.setItem('studentAbsences', JSON.stringify(studentAbsences));
            localStorage.setItem('dailyAbsences', JSON.stringify(dailyAbsences));
            
            // عرض إشعار النجاح
            showToast(`تم تسجيل غياب الطالب ${studentName} في تاريخ ${formattedDate} بنجاح!`);
            
            // إغلاق النافذة المنبثقة
            bootstrap.Modal.getInstance(document.getElementById('absenceDateModal')).hide();
            
            // تحديث الواجهة
            if (document.getElementById('studentPage').style.display === 'block') {
                loadStudentAbsences(studentName);
            } else {
                updateStudentCard(studentName, className);
            }
        }

        // دالة جديدة لتحديث بطاقة الطالب فقط
        function updateStudentCard(studentName, className) {
            // البحث عن بطاقة الطالب وتحديثها
            const cards = document.querySelectorAll('.student-card');
            cards.forEach(card => {
                const nameElement = card.querySelector('.student-name span');
                if (nameElement && nameElement.textContent === studentName) {
                    const details = studentDetails[studentName] || {};
                    const totalAbsences = (details.totalAbsences9 || 0) + (details.totalAbsences10 || 0) + (studentAbsences[studentName] ? studentAbsences[studentName].length : 0);
                    
                    // تحديث معلومات الغياب
                    let absenceInfo = '';
                    if (totalAbsences > 0) {
                        absenceInfo = `<div class="mt-2 text-danger"><i class="fas fa-exclamation-circle"></i> غيابات: ${totalAbsences}</div>`;
                        // إضافة مؤشر الغياب إذا لم يكن موجودًا
                        if (!card.querySelector('.absence-indicator')) {
                            const nameDiv = card.querySelector('.student-name');
                            const indicator = document.createElement('span');
                            indicator.className = 'absence-indicator';
                            indicator.textContent = 'غياب';
                            nameDiv.appendChild(indicator);
                        }
                    }
                    
                    // البحث عن قسم معلومات الغياب وتحديثه
                    const existingAbsenceInfo = card.querySelector('.mt-2.text-danger');
                    if (existingAbsenceInfo) {
                        existingAbsenceInfo.outerHTML = absenceInfo;
                    } else {
                        const classDiv = card.querySelector('.student-class');
                        classDiv.insertAdjacentHTML('afterend', absenceInfo);
                    }
                }
            });
        }

        // دالة جديدة لتسجيل الغياب من صفحة الطالب
        function markSingleAbsenceFromPage() {
            if (!currentStudent) return;
            
            const className = getCurrentClass(currentStudent);
            markSingleAbsence(currentStudent, className);
        }

        // الحصول على الصف الحالي للطالب
        function getCurrentGrade(studentName) {
            for (const grade in studentsData) {
                for (const className in studentsData[grade]) {
                    if (studentsData[grade][className].includes(studentName)) {
                        return grade;
                    }
                }
            }
            return '';
        }

        // فتح صفحة الطالب
        function openStudentPage(studentName, className) {
            if (currentUserType === 'limited') {
                // المستخدم المحدود لا يمكنه عرض صفحة الطالب
                return;
            }
            
            currentStudent = studentName;
            document.getElementById('mainPage').style.display = 'none';
            document.getElementById('studentPage').style.display = 'block';
            document.getElementById('highAbsencePage').style.display = 'none';
            document.getElementById('reportsPage').style.display = 'none';
            document.getElementById('schoolAbsencePage').style.display = 'none';
            
            // عرض/إخفاء الميزات حسب نوع المستخدم
            if (currentUserType === 'full') {
                document.getElementById('editInfoBtn').style.display = 'block';
                document.getElementById('markAbsenceBtn').style.display = 'block';
                document.getElementById('addActionBtn').style.display = 'block';
            }
            
            loadStudentInfo(studentName, className);
            loadStudentActions(studentName);
            loadStudentAbsences(studentName);
        }

        // تحميل معلومات الطالب
        function loadStudentInfo(studentName, className) {
            const details = studentDetails[studentName] || {};
            const info = studentInfo[studentName] || {};
            
            document.getElementById('studentPageName').textContent = studentName;
            document.getElementById('studentPageClass').textContent = className;
            document.getElementById('studentPageNationalId').textContent = details.nationalId || info.nationalId || '-';
            
            document.getElementById('displayName').textContent = studentName;
            document.getElementById('displayNationalId').textContent = details.nationalId || info.nationalId || '-';
            document.getElementById('displayBirthDate').textContent = info.birthDate || '-';
            document.getElementById('displayAddress').textContent = info.address || '-';
            
            document.getElementById('displayPhone1').textContent = details.phone1 || info.phone1 || '-';
            document.getElementById('displayPhone2').textContent = details.phone2 || info.phone2 || '-';
            document.getElementById('displayEmail').textContent = info.email || '-';
            document.getElementById('displayParentName').textContent = info.parentName || '-';
            
            document.getElementById('editName').value = studentName;
            document.getElementById('editNationalId').value = details.nationalId || info.nationalId || '';
            document.getElementById('editBirthDate').value = info.birthDate || '';
            document.getElementById('editAddress').value = info.address || '';
            document.getElementById('editPhone1').value = details.phone1 || info.phone1 || '';
            document.getElementById('editPhone2').value = details.phone2 || info.phone2 || '';
            document.getElementById('editEmail').value = info.email || '';
            document.getElementById('editParentName').value = info.parentName || '';
        }

        // تحميل إجراءات الطالب
        function loadStudentActions(studentName) {
            const actions = getStudentActions(studentName);
            const actionsList = document.getElementById('studentActionsList');
            
            if (actions.length === 0) {
                actionsList.innerHTML = '<p class="text-muted">لا توجد إجراءات مسجلة</p>';
                return;
            }
            
            const sortedActions = [...actions].reverse();
            actionsList.innerHTML = sortedActions.map(action => `
                <div class="action-item">
                    <div class="action-date"><i class="fas fa-calendar"></i> ${action.date} ${action.time}</div>
                    <div class="action-type"><span class="action-badge badge-${getActionBadgeClass(action.type)}">${action.type}</span></div>
                    ${action.note ? `<div class="action-note">${action.note}</div>` : ''}
                    ${currentUserType === 'full' ? `<button class="btn btn-sm btn-danger mt-2" onclick="deleteAction('${action.id}')"><i class="fas fa-trash"></i> حذف</button>` : ''}
                </div>
            `).join('');
        }

        // تحميل سجل غياب الطالب
        function loadStudentAbsences(studentName) {
            const details = studentDetails[studentName] || {};
            const systemAbsences = studentAbsences[studentName] || [];
            const absencesList = document.getElementById('studentAbsencesList');
            
            // دمج سجلات الغياب لشهر 9 و10 مع سجلات الغياب في النظام
            const allAbsences = [];
            
            // إضافة سجلات الغياب لشهر 9
            if (details.absences9) {
                const absences9 = details.absences9.split(', ');
                absences9.forEach(date => {
                    allAbsences.push({
                        date: date,
                        reason: 'غياب مسجل مسبقاً',
                        source: '9月'
                    });
                });
            }
            
            // إضافة سجلات الغياب لشهر 10
            if (details.absences10) {
                const absences10 = details.absences10.split(', ');
                absences10.forEach(date => {
                    allAbsences.push({
                        date: date,
                        reason: 'غياب مسجل مسبقاً',
                        source: '10月'
                    });
                });
            }
            
            // إضافة سجلات الغياب في النظام
            systemAbsences.forEach(absence => {
                allAbsences.push({
                    date: absence.date,
                    reason: absence.reason || 'لم يحدد السبب',
                    source: 'system',
                    id: absence.id
                });
            });
            
            // ترتيب حسب التاريخ
            allAbsences.sort((a, b) => {
                const dateA = a.date.split('/').reverse().join('-');
                const dateB = b.date.split('/').reverse().join('-');
                return new Date(dateB) - new Date(dateA);
            });
            
            if (allAbsences.length === 0) {
                absencesList.innerHTML = '<p class="text-muted">لا توجد غيابات مسجلة</p>';
                return;
            }
            
            const totalAbsences = (details.totalAbsences9 || 0) + (details.totalAbsences10 || 0) + systemAbsences.length;
            
            absencesList.innerHTML = `
                <div class="mb-3">
                    <strong>مجموع أيام الغياب: ${totalAbsences}</strong>
                </div>
                <div class="absence-list">
                    ${allAbsences.map(absence => {
                        let dateDisplay = absence.date;
                        if (absence.fullDate) {
                            const date = new Date(absence.fullDate);
                            dateDisplay = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
                        }
                        
                        return `
                            <div class="absence-item">
                                <div>
                                    <div class="absence-date">${dateDisplay}</div>
                                    <div class="text-muted">${absence.reason}</div>
                                </div>
                                ${currentUserType === 'full' && absence.source === 'system' ? 
                                    `<button class="delete-absence-btn" onclick="deleteAbsence('${absence.id}')"><i class="fas fa-trash"></i></button>` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
        }

        // الحصول على إجراءات الطالب
        function getStudentActions(studentName) {
            return studentActions[studentName] || [];
        }

        // الحصول على فئة شارة الإجراء
        function getActionBadgeClass(actionType) {
            const classes = { 
                'مغادرة': 'warning', 
                'تنبيه': 'info', 
                'إنذار': 'danger', 
                'استدعاء ولي أمر': 'secondary', 
                'مخالفة': 'danger', 
                'تأخير': 'warning',
                'تبليغ غياب': 'danger'
            };
            return classes[actionType] || 'secondary';
        }

        // تبديل وضع التحرير - تم إصلاح المشكلة هنا
        function toggleEditMode() {
            if (currentUserType !== 'full') {
                return;
            }
            
            const isEditing = document.getElementById('editButtons').classList.contains('d-none');
            if (isEditing) {
                // التأكد من نسخ القيم من عناصر العرض إلى عناصر الإدخال
                document.getElementById('editName').value = document.getElementById('displayName').textContent;
                document.getElementById('editNationalId').value = document.getElementById('displayNationalId').textContent;
                document.getElementById('editBirthDate').value = document.getElementById('displayBirthDate').textContent;
                document.getElementById('editAddress').value = document.getElementById('displayAddress').textContent;
                document.getElementById('editPhone1').value = document.getElementById('displayPhone1').textContent;
                document.getElementById('editPhone2').value = document.getElementById('displayPhone2').textContent;
                document.getElementById('editEmail').value = document.getElementById('displayEmail').textContent;
                document.getElementById('editParentName').value = document.getElementById('displayParentName').textContent;
                
                document.querySelectorAll('[id^="display"]').forEach(el => el.classList.add('d-none'));
                document.querySelectorAll('[id^="edit"]').forEach(el => el.classList.remove('d-none'));
                document.getElementById('editButtons').classList.remove('d-none');
            } else {
                document.querySelectorAll('[id^="display"]').forEach(el => el.classList.remove('d-none'));
                document.querySelectorAll('[id^="edit"]').forEach(el => el.classList.add('d-none'));
                document.getElementById('editButtons').classList.add('d-none');
            }
        }

        // حفظ معلومات الطالب
        function saveStudentInfo() {
            if (currentUserType !== 'full') {
                return;
            }
            
            const info = {
                nationalId: document.getElementById('editNationalId').value,
                birthDate: document.getElementById('editBirthDate').value,
                address: document.getElementById('editAddress').value,
                phone1: document.getElementById('editPhone1').value,
                phone2: document.getElementById('editPhone2').value,
                email: document.getElementById('editEmail').value,
                parentName: document.getElementById('editParentName').value
            };
            
            studentInfo[currentStudent] = info;
            localStorage.setItem('studentInfo', JSON.stringify(studentInfo));
            
            loadStudentInfo(currentStudent, getCurrentClass(currentStudent));
            toggleEditMode();
            
            showToast('تم حفظ المعلومات بنجاح!');
        }

        // إلغاء التحرير
        function cancelEdit() {
            loadStudentInfo(currentStudent, getCurrentClass(currentStudent));
            toggleEditMode();
        }

        // الحصول على الشعبة الحالية
        function getCurrentClass(studentName) {
            for (const [grade, classes] of Object.entries(studentsData)) {
                for (const [className, students] of Object.entries(classes)) {
                    if (students.includes(studentName)) {
                        return className;
                    }
                }
            }
            return '';
        }

        // عرض نافذة إضافة إجراء
        function showAddActionModal() {
            if (currentUserType !== 'full') {
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('addActionModal'));
            modal.show();
        }

        // إضافة إجراء جديد
        function addNewAction() {
            const actionType = document.getElementById('newActionType').value;
            const actionNote = document.getElementById('newActionNote').value;
            
            if (!actionType) {
                alert('الرجاء اختيار نوع الإجراء');
                return;
            }
            
            const now = new Date();
            const actionId = `action-${Date.now()}`;
            const action = {
                id: actionId,
                type: actionType,
                note: actionNote,
                date: now.toLocaleDateString('ar-SA'),
                time: now.toLocaleTimeString('ar-SA', { hour: '2-digit', minute: '2-digit' })
            };
            
            if (!studentActions[currentStudent]) {
                studentActions[currentStudent] = [];
            }
            
            studentActions[currentStudent].push(action);
            localStorage.setItem('studentActions', JSON.stringify(studentActions));
            
            loadStudentActions(currentStudent);
            bootstrap.Modal.getInstance(document.getElementById('addActionModal')).hide();
            
            document.getElementById('newActionType').value = '';
            document.getElementById('newActionNote').value = '';
            
            showToast('تم إضافة الإجراء بنجاح!');
        }

        // حذف الإجراء
        function deleteAction(actionId) {
            if (currentUserType !== 'full') {
                return;
            }
            
            if (confirm('هل أنت متأكد من حذف هذا الإجراء؟')) {
                studentActions[currentStudent] = studentActions[currentStudent].filter(action => action.id !== actionId);
                localStorage.setItem('studentActions', JSON.stringify(studentActions));
                loadStudentActions(currentStudent);
                showToast('تم حذف الإجراء بنجاح!');
            }
        }

        // حذف سجل الغياب
        function deleteAbsence(absenceId) {
            if (currentUserType !== 'full') {
                return;
            }
            
            if (confirm('هل أنت متأكد من حذف هذا الغياب؟')) {
                // البحث عن الغياب وحذفه من السجل اليومي أيضاً
                const absence = studentAbsences[currentStudent].find(a => a.id === absenceId);
                if (absence && absence.fullDate) {
                    const dateKey = absence.fullDate;
                    if (dailyAbsences[dateKey] && dailyAbsences[dateKey][currentStudent]) {
                        delete dailyAbsences[dateKey][currentStudent];
                        localStorage.setItem('dailyAbsences', JSON.stringify(dailyAbsences));
                    }
                }
                
                studentAbsences[currentStudent] = studentAbsences[currentStudent].filter(absence => absence.id !== absenceId);
                localStorage.setItem('studentAbsences', JSON.stringify(studentAbsences));
                loadStudentAbsences(currentStudent);
                showToast('تم حذف الغياب بنجاح!');
            }
        }

        // العودة للصفحة الرئيسية
        function backToMain() {
            document.getElementById('studentPage').style.display = 'none';
            document.getElementById('highAbsencePage').style.display = 'none';
            document.getElementById('reportsPage').style.display = 'none';
            document.getElementById('schoolAbsencePage').style.display = 'none';
            document.getElementById('mainPage').style.display = 'block';
            currentStudent = null;
        }

        // عرض صفحة غياب المدرسة
        function showSchoolAbsencePage() {
            if (currentUserType !== 'full') {
                return;
            }
            
            document.getElementById('mainPage').style.display = 'none';
            document.getElementById('studentPage').style.display = 'none';
            document.getElementById('highAbsencePage').style.display = 'none';
            document.getElementById('reportsPage').style.display = 'none';
            document.getElementById('schoolAbsencePage').style.display = 'block';
            
            // تعيين تاريخ اليوم افتراضياً
            const today = new Date();
            document.getElementById('absenceDateFilter').value = today.toISOString().split('T')[0];
            
            loadClassAbsences();
        }

        // تحديث فلاتر الشعبة في صفحة غياب المدرسة
        function updateAbsenceClassFilter() {
            const grade = document.getElementById('absenceGradeFilter').value;
            const classSelect = document.getElementById('absenceClassFilter');
            
            // مسح الخيارات الحالية
            classSelect.innerHTML = '<option value="">اختر الشعبة</option>';
            
            if (grade && studentsData[grade]) {
                // إضافة خيارات الشعب المتاحة للصف المحدد
                Object.keys(studentsData[grade]).forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    classSelect.appendChild(option);
                });
            }
            
            loadClassAbsences();
        }

        // تحميل غيابات الشعبة
        function loadClassAbsences() {
            const grade = document.getElementById('absenceGradeFilter').value;
            const className = document.getElementById('absenceClassFilter').value;
            const dateFilter = document.getElementById('absenceDateFilter').value;
            const tableBody = document.getElementById('schoolAbsenceTableBody');
            const monthlyTableBody = document.getElementById('monthlyAbsenceTableBody');
            
            // مسح المحتوى الحالي
            tableBody.innerHTML = '';
            monthlyTableBody.innerHTML = '';
            
            if (!grade || !className || !dateFilter) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">الرجاء اختيار الصف والشعبة والتاريخ</td>
                    </tr>
                `;
                monthlyTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">الرجاء اختيار الصف والشعبة</td>
                    </tr>
                `;
                return;
            }
            
            if (!studentsData[grade] || !studentsData[grade][className]) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">لا توجد بيانات لهذه الشعبة</td>
                    </tr>
                `;
                monthlyTableBody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">لا توجد بيانات لهذه الشعبة</td>
                    </tr>
                `;
                return;
            }
            
            const students = studentsData[grade][className];
            const dateKey = dateFilter;
            const dayAbsences = dailyAbsences[dateKey] || {};
            
            // إنشاء جدول الغيابات اليومي
            let presentCount = 0;
            let absentCount = 0;
            
            students.forEach(studentName => {
                const details = studentDetails[studentName] || {};
                const isAbsent = dayAbsences[studentName] || false;
                const statusClass = isAbsent ? 'status-absent' : 'status-present';
                const statusText = isAbsent ? 'غائب' : 'حاضر';
                
                if (isAbsent) {
                    absentCount++;
                } else {
                    presentCount++;
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${studentName}</td>
                    <td>${details.nationalId || '-'}</td>
                    <td>${details.phone1 || details.phone2 || '-'}</td>
                    <td><span class="absence-status ${statusClass}">${statusText}</span></td>
                    <td>${isAbsent ? 'غياب مسجل اليوم' : '-'}</td>
                `;
                tableBody.appendChild(row);
            });
            
            // تحديث إحصائيات الغياب
            document.getElementById('totalPresent').textContent = presentCount;
            document.getElementById('totalAbsent').textContent = absentCount;
            const attendanceRate = Math.round((presentCount / (presentCount + absentCount)) * 100);
            document.getElementById('attendanceRate').textContent = `${attendanceRate}%`;
            
            // إنشاء جدول الغيابات الشهري
            const month = new Date(dateFilter).getMonth() + 1;
            const year = new Date(dateFilter).getFullYear();
            const daysInMonth = new Date(year, month, 0).getDate();
            
            students.forEach(studentName => {
                const details = studentDetails[studentName] || {};
                const systemAbsences = studentAbsences[studentName] || [];
                const totalAbsences9 = details.totalAbsences9 || 0;
                const totalAbsences10 = details.totalAbsences10 || 0;
                
                let monthAbsences = [];
                let totalMonthAbsences = 0;
                
                // حساب الغيابات في الشهر المحدد
                if (month === 9) {
                    if (details.absences9) {
                        monthAbsences = details.absences9.split(', ');
                        totalMonthAbsences = totalAbsences9;
                    }
                } else if (month === 10) {
                    if (details.absences10) {
                        monthAbsences = details.absences10.split(', ');
                        totalMonthAbsences = totalAbsences10;
                    }
                }
                
                // إضافة الغيابات المسجلة في النظام
                systemAbsences.forEach(absence => {
                    const absenceDate = absence.date.split('/');
                    const absenceMonth = parseInt(absenceDate[1]);
                    const absenceYear = parseInt(absenceDate[2]) || year;
                    
                    if (absenceMonth === month && absenceYear === year) {
                        monthAbsences.push(absence.date);
                        totalMonthAbsences++;
                    }
                });
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${studentName}</td>
                    <td>${details.nationalId || '-'}</td>
                    <td>${details.phone1 || details.phone2 || '-'}</td>
                    <td>${totalMonthAbsences}</td>
                    <td>${monthAbsences.join(', ')}</td>
                `;
                monthlyTableBody.appendChild(row);
            });
        }

        // تبديل العرض بين اليومي والشهري
        function toggleView(viewType) {
            const dailyView = document.getElementById('dailyView');
            const monthlyView = document.getElementById('monthlyView');
            const dailyBtn = document.getElementById('dailyViewBtn');
            const monthlyBtn = document.getElementById('monthlyViewBtn');
            
            if (viewType === 'daily') {
                dailyView.style.display = 'block';
                monthlyView.style.display = 'none';
                dailyBtn.classList.add('active');
                monthlyBtn.classList.remove('active');
            } else {
                dailyView.style.display = 'none';
                monthlyView.style.display = 'block';
                dailyBtn.classList.remove('active');
                monthlyBtn.classList.add('active');
            }
        }

        // طباعة تقرير غياب المدرسة
        function printSchoolAbsenceReport() {
            const grade = document.getElementById('absenceGradeFilter').value;
            const className = document.getElementById('absenceClassFilter').value;
            const dateFilter = document.getElementById('absenceDateFilter').value;
            const isMonthlyView = document.getElementById('monthlyView').style.display === 'block';
            
            if (!grade || !className || !dateFilter) {
                showToast('الرجاء اختيار الصف والشعبة والتاريخ', 'warning');
                return;
            }
            
            const tableContent = isMonthlyView ? 
                document.getElementById('monthlyAbsenceTable').outerHTML : 
                document.getElementById('schoolAbsenceTable').outerHTML;
            
            // بناء محتوى الطباعة
            const printContent = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>تقرير غياب المدرسة</title>
                    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
                    <style>
                        @page {
                            size: A4;
                            margin: 1.5cm;
                        }
                        body {
                            font-family: 'Tajawal', sans-serif;
                            font-size: 13px;
                            line-height: 1.6;
                            color: #333;
                            margin: 0;
                            padding: 0;
                        }
                        .report-header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #333;
                            padding-bottom: 15px;
                        }
                        .report-header h1 {
                            margin: 0;
                            font-size: 24px;
                            font-weight: 700;
                        }
                        .report-header h2 {
                            margin: 5px 0 0;
                            font-size: 16px;
                            font-weight: 500;
                        }
                        .report-info {
                            margin-bottom: 20px;
                            background: #f8f9fa;
                            padding: 15px;
                            border-radius: 8px;
                        }
                        .absence-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                        }
                        .absence-table th, .absence-table td {
                            border: 1px solid #ddd;
                            padding: 12px;
                            text-align: right;
                        }
                        .absence-table th {
                            background-color: #f2f2f2;
                            font-weight: 600;
                        }
                        .absence-table tr:nth-child(even) {
                            background-color: #f9f9f9;
                        }
                        .absence-status {
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 0.85rem;
                            font-weight: 500;
                        }
                        .status-present {
                            background-color: #d4edda;
                            color: #155724;
                        }
                        .status-absent {
                            background-color: #f8d7da;
                            color: #721c24;
                        }
                        .report-footer {
                            text-align: center;
                            margin-top: 30px;
                            font-size: 12px;
                            color: #777;
                            border-top: 1px solid #ccc;
                            padding-top: 10px;
                        }
                        .absence-stats {
                            background: #f8f9fa;
                            border-radius: 10px;
                            padding: 15px;
                            margin-bottom: 20px;
                            display: flex;
                            justify-content: space-around;
                        }
                        .stat-item {
                            text-align: center;
                        }
                        .stat-number {
                            font-size: 1.5rem;
                            font-weight: 700;
                            color: #667eea;
                        }
                        .stat-label {
                            color: #666;
                            font-size: 0.9rem;
                        }
                    </style>
                </head>
                <body>
                    <div class="report-header">
                        <h1>مدرسة ابن خفاجة</h1>
                        <h2>تقرير غياب المدرسة (${isMonthlyView ? 'شهري' : 'يومي'})</h2>
                    </div>
                    
                    <div class="report-info">
                        <strong>الصف:</strong> ${grade}<br>
                        <strong>الشعبة:</strong> ${className}<br>
                        <strong>${isMonthlyView ? 'الشهر' : 'التاريخ'}:</strong> ${isMonthlyView ? 
                            `${new Date(dateFilter).toLocaleDateString('ar-SA', { month: 'long', year: 'numeric' })}` : 
                            dateFilter}
                    </div>
                    
                    ${isMonthlyView ? '' : `
                        <div class="absence-stats">
                            <div class="stat-item">
                                <div class="stat-number">${document.getElementById('totalPresent').textContent}</div>
                                <div class="stat-label">إجمالي الحضور</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${document.getElementById('totalAbsent').textContent}</div>
                                <div class="stat-label">إجمالي الغياب</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">${document.getElementById('attendanceRate').textContent}</div>
                                <div class="stat-label">نسبة الحضور</div>
                            </div>
                        </div>
                    `}
                    
                    ${tableContent}
                    
                    <div class="report-footer">
                        <p>تم إنشاء هذا التقرير في ${new Date().toLocaleDateString('en-US')} ${new Date().toLocaleTimeString('en-US')}</p>
                        <p>نظام إدارة الطلاب - مدرسة ابن خفاجة</p>
                    </div>
                </body>
                </html>
            `;
            
            // فتح نافذة جديدة وكتابة المحتوى
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // انتظار تحميل المحتوى ثم الطباعة
            printWindow.onload = function() {
                printWindow.print();
                printWindow.onafterprint = function() {
                    printWindow.close();
                };
            };
        }

        // تصدير غياب المدرسة إلى Excel
        function exportSchoolAbsenceToExcel() {
            const grade = document.getElementById('absenceGradeFilter').value;
            const className = document.getElementById('absenceClassFilter').value;
            const dateFilter = document.getElementById('absenceDateFilter').value;
            const isMonthlyView = document.getElementById('monthlyView').style.display === 'block';
            
            if (!grade || !className || !dateFilter) {
                showToast('الرجاء اختيار الصف والشعبة والتاريخ', 'warning');
                return;
            }
            
            if (!studentsData[grade] || !studentsData[grade][className]) {
                showToast('لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            const students = studentsData[grade][className];
            const dateKey = dateFilter;
            const dayAbsences = dailyAbsences[dateKey] || {};
            
            // جمع بيانات الجدول
            const rows = [];
            
            if (isMonthlyView) {
                // بيانات العرض الشهري
                const month = new Date(dateFilter).getMonth() + 1;
                const year = new Date(dateFilter).getFullYear();
                
                students.forEach(studentName => {
                    const details = studentDetails[studentName] || {};
                    const systemAbsences = studentAbsences[studentName] || [];
                    const totalAbsences9 = details.totalAbsences9 || 0;
                    const totalAbsences10 = details.totalAbsences10 || 0;
                    
                    let monthAbsences = [];
                    let totalMonthAbsences = 0;
                    
                    // حساب الغيابات في الشهر المحدد
                    if (month === 9) {
                        if (details.absences9) {
                            monthAbsences = details.absences9.split(', ');
                            totalMonthAbsences = totalAbsences9;
                        }
                    } else if (month === 10) {
                        if (details.absences10) {
                            monthAbsences = details.absences10.split(', ');
                            totalMonthAbsences = totalAbsences10;
                        }
                    }
                    
                    // إضافة الغيابات المسجلة في النظام
                    systemAbsences.forEach(absence => {
                        const absenceDate = absence.date.split('/');
                        const absenceMonth = parseInt(absenceDate[1]);
                        const absenceYear = parseInt(absenceDate[2]) || year;
                        
                        if (absenceMonth === month && absenceYear === year) {
                            monthAbsences.push(absence.date);
                            totalMonthAbsences++;
                        }
                    });
                    
                    rows.push([
                        studentName,
                        details.nationalId || '-',
                        details.phone1 || details.phone2 || '-',
                        totalMonthAbsences,
                        monthAbsences.join(', ')
                    ]);
                });
            } else {
                // بيانات العرض اليومي
                students.forEach(studentName => {
                    const details = studentDetails[studentName] || {};
                    const isAbsent = dayAbsences[studentName] || false;
                    const statusText = isAbsent ? 'غائب' : 'حاضر';
                    
                    rows.push([
                        studentName,
                        details.nationalId || '-',
                        details.phone1 || details.phone2 || '-',
                        statusText,
                        isAbsent ? 'غياب مسجل اليوم' : '-'
                    ]);
                });
            }
            
            // إنشاء مصنف العمل
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([
                isMonthlyView ? 
                    ['اسم الطالب', 'الرقم الوطني', 'هاتف ولي الأمر', 'مجموع أيام الغياب', 'تواريخ الغياب'] :
                    ['اسم الطالب', 'الرقم الوطني', 'هاتف ولي الأمر', 'حالة الحضور', 'ملاحظات'],
                ...rows
            ]);
            
            // إضافة ورقة العمل إلى المصنف
            XLSX.utils.book_append_sheet(wb, ws, 'غياب المدرسة');
            
            // تصدير الملف
            const fileName = `school_absence_${grade}_${className}_${dateFilter}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showToast('تم تصدير البيانات إلى Excel بنجاح!');
        }

        // إنشاء تقرير قابل للطباعة - تم إصلاح مشكلة التاريخ هنا
        function generatePrintableReport() {
            if (!currentStudent) {
                alert('الرجاء اختيار طالب أولاً');
                return;
            }

            const studentName = currentStudent;
            const studentClass = getCurrentClass(studentName);
            const details = studentDetails[studentName] || {};
            const info = studentInfo[studentName] || {};
            const actions = getStudentActions(studentName);
            const systemAbsences = studentAbsences[studentName] || [];

            // ترتيب الإجراءات
            const sortedActions = [...actions].reverse();

            // دمج جميع سجلات الغياب
            const allAbsences = [];
            
            // إضافة سجلات الغياب لشهر 9
            if (details.absences9) {
                const absences9 = details.absences9.split(', ');
                absences9.forEach(date => {
                    allAbsences.push({
                        date: date,
                        reason: 'غياب مسجل مسبقاً',
                        source: '9月'
                    });
                });
            }
            
            // إضافة سجلات الغياب لشهر 10
            if (details.absences10) {
                const absences10 = details.absences10.split(', ');
                absences10.forEach(date => {
                    allAbsences.push({
                        date: date,
                        reason: 'غياب مسجل مسبقاً',
                        source: '10月'
                    });
                });
            }
            
            // إضافة سجلات الغياب في النظام
            systemAbsences.forEach(absence => {
                allAbsences.push({
                    date: absence.date,
                    reason: absence.reason || 'لم يحدد السبب',
                    source: 'system'
                });
            });
            
            // ترتيب حسب التاريخ
            allAbsences.sort((a, b) => {
                const dateA = a.date.split('/').reverse().join('-');
                const dateB = b.date.split('/').reverse().join('-');
                return new Date(dateB) - new Date(dateA);
            });

            const totalAbsences = (details.totalAbsences9 || 0) + (details.totalAbsences10 || 0) + systemAbsences.length;

            // بناء محتوى التقرير
            const reportContent = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>تقرير طالب - ${studentName}</title>
                    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
                    <style>
                        @page {
                            size: A4;
                            margin: 1.5cm;
                        }
                        body {
                            font-family: 'Tajawal', sans-serif;
                            font-size: 13px;
                            line-height: 1.6;
                            color: #333;
                            margin: 0;
                            padding: 0;
                        }
                        .report-header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #333;
                            padding-bottom: 15px;
                        }
                        .report-header h1 {
                            margin: 0;
                            font-size: 24px;
                            font-weight: 700;
                        }
                        .report-header h2 {
                            margin: 5px 0 0;
                            font-size: 16px;
                            font-weight: 500;
                        }
                        .info-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 20px;
                        }
                        .info-table th, .info-table td {
                            border: 1px solid #ddd;
                            padding: 10px;
                            text-align: right;
                            vertical-align: top;
                        }
                        .info-table th {
                            background-color: #f2f2f2;
                            font-weight: 600;
                            width: 30%;
                        }
                        .section-title {
                            font-size: 16px;
                            font-weight: 700;
                            margin-top: 25px;
                            margin-bottom: 10px;
                            border-bottom: 1px solid #ccc;
                            padding-bottom: 5px;
                        }
                        /* تحسين تنسيق الطباعة للغياب */
                        .absence-list-print {
                            display: flex;
                            flex-wrap: wrap;
                            gap: 10px;
                            margin-top: 15px;
                        }
                        
                        .absence-item-print {
                            background: #f9f9f9;
                            border: 1px solid #ddd;
                            border-radius: 5px;
                            padding: 5px 10px;
                            font-size: 11px;
                            width: calc(25% - 10px);
                            box-sizing: border-box;
                        }
                        
                        .absence-date-print {
                            font-weight: 600;
                        }
                        
                        .absence-source-print {
                            font-size: 10px;
                            color: #666;
                            background-color: #f0f0f0;
                            padding: 1px 3px;
                            border-radius: 3px;
                            margin-right: 3px;
                        }
                        
                        .action-item-print {
                            margin-bottom: 8px;
                            padding-bottom: 8px;
                            border-bottom: 1px dashed #eee;
                        }
                        
                        .action-item-print:last-child {
                            border-bottom: none;
                        }
                        
                        .action-type-print {
                            font-weight: 600;
                        }
                        
                        .action-date-print {
                            font-size: 12px;
                            color: #666;
                        }
                        
                        .report-footer {
                            text-align: center;
                            margin-top: 30px;
                            font-size: 12px;
                            color: #777;
                            border-top: 1px solid #ccc;
                            padding-top: 10px;
                        }
                        
                        .no-data {
                            color: #888;
                            font-style: italic;
                        }
                    </style>
                </head>
                <body>
                    <div class="report-header">
                        <h1>مدرسة ابن خفاجة</h1>
                        <h2>تقرير الطالب</h2>
                    </div>

                    <table class="info-table">
                        <tr>
                            <th>اسم الطالب</th>
                            <td>${studentName}</td>
                        </tr>
                        <tr>
                            <th>الصف</th>
                            <td>${studentClass}</td>
                        </tr>
                        <tr>
                            <th>الرقم الوطني</th>
                            <td>${details.nationalId || info.nationalId || '-'}</td>
                        </tr>
                        <tr>
                            <th>تاريخ الميلاد</th>
                            <td>${info.birthDate || '-'}</td>
                        </tr>
                        <tr>
                            <th>العنوان</th>
                            <td>${info.address || '-'}</td>
                        </tr>
                        <tr>
                            <th>هاتف ولي الأمر 1</th>
                            <td>${details.phone1 || info.phone1 || '-'}</td>
                        </tr>
                        <tr>
                            <th>هاتف ولي الأمر 2</th>
                            <td>${details.phone2 || info.phone2 || '-'}</td>
                        </tr>
                        <tr>
                            <th>البريد الإلكتروني</th>
                            <td>${info.email || '-'}</td>
                        </tr>
                        <tr>
                            <th>اسم ولي الأمر</th>
                            <td>${info.parentName || '-'}</td>
                        </tr>
                    </table>

                    <div class="section-title">سجل الغياب</div>
                    <table class="info-table">
                        <tr>
                            <th>مجموع أيام الغياب</th>
                            <td>${totalAbsences}</td>
                        </tr>
                    </table>
                    
                    ${allAbsences.length > 0 ? 
                        `<div class="section-title">تفاصيل الغياب</div>
                        <div class="absence-list-print">
                            ${allAbsences.map(absence => `
                                <div class="absence-item-print">
                                    <div class="absence-date-print">${absence.date}</div>
                                    <div>${absence.reason}</div>
                                    <div class="absence-source-print">${absence.source === 'system' ? 'نظام' : absence.source}</div>
                                </div>
                            `).join('')}
                        </div>` : 
                        '<p class="no-data">لا توجد غيابات مسجلة</p>'
                    }

                    <div class="section-title">سجل الإجراءات</div>
                    ${sortedActions.length > 0 ? 
                        sortedActions.map(action => `
                            <div class="action-item-print">
                                <div class="action-type-print">${action.type}</div>
                                <div class="action-date-print">${action.date} ${action.time}</div>
                                ${action.note ? `<div>${action.note}</div>` : ''}
                            </div>
                        `).join('') : 
                        '<p class="no-data">لا توجد إجراءات مسجلة</p>'
                    }

                    <div class="report-footer">
                        <p>تم إنشاء هذا التقرير في ${new Date().toLocaleDateString('en-US')} ${new Date().toLocaleTimeString('en-US')}</p>
                        <p>نظام إدارة الطلاب - مدرسة ابن خفاجة</p>
                    </div>
                </body>
                </html>
            `;

            // فتح نافذة جديدة وكتابة المحتوى
            const printWindow = window.open('', '_blank');
            printWindow.document.write(reportContent);
            printWindow.document.close();

            // انتظار تحميل المحتوى ثم الطباعة
            printWindow.onload = function() {
                printWindow.print();
                // إغلاق النافذة بعد الطباعة (قد لا يعمل في جميع المتصفحات)
                printWindow.onafterprint = function() {
                    printWindow.close();
                };
            };
        }

        // تحديث الإحصائيات
        function updateStats() {
            let totalStudents = 0;
            let totalClasses = 0;
            let totalGrades = 0;
            
            for (const grade of Object.keys(studentsData)) {
                totalGrades++;
                for (const className of Object.keys(studentsData[grade])) {
                    totalClasses++;
                    totalStudents += studentsData[grade][className].length;
                }
            }
            
            document.getElementById('totalStudents').textContent = totalStudents;
            document.getElementById('totalClasses').textContent = totalClasses;
            document.getElementById('totalGrades').textContent = totalGrades;
        }

        // عرض جميع الإحصائيات
        function showAllStats() {
            let totalStudents = 0;
            let details = [];
            
            for (const grade of Object.keys(studentsData)) {
                let gradeStudents = 0;
                for (const className of Object.keys(studentsData[grade])) {
                    const classCount = studentsData[grade][className].length;
                    gradeStudents += classCount;
                    details.push(`${grade} - ${className}: ${classCount} طالب`);
                }
                totalStudents += gradeStudents;
            }
            
            alert(`إحصائيات نظام إدارة الطلاب\n\n` +
                  `إجمالي الطلاب: ${totalStudents}\n` +
                  `إجمالي الصفوف: ${Object.keys(studentsData).length}\n\n` +
                  `تفاصيل الشعب:\n${details.join('\n')}`);
        }

        // تصدير البيانات
        function exportData() {
            const dataStr = JSON.stringify({ 
                students: studentsData, 
                details: studentDetails, 
                actions: studentActions, 
                info: studentInfo,
                absences: studentAbsences,
                dailyAbsences: dailyAbsences
            }, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            const exportFileDefaultName = `students_data_${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showToast('تم تصدير البيانات بنجاح!');
        }

        // البحث عن الطلاب
        function searchStudents() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            
            if (!searchTerm) {
                clearSearch();
                return;
            }
            
            let foundStudents = [];
            
            // البحث في جميع الصفوف والشعب
            for (const grade in studentsData) {
                for (const className in studentsData[grade]) {
                    studentsData[grade][className].forEach(studentName => {
                        if (studentName.toLowerCase().includes(searchTerm)) {
                            foundStudents.push({
                                name: studentName,
                                grade: grade,
                                class: className
                            });
                        }
                    });
                }
            }

            const resultsContainer = document.getElementById('searchResultsContainer');
            const resultsList = document.getElementById('searchResultsList');
            const tabsContainer = document.getElementById('classTabsContainer');
            
            // إخفاء التبويبات الأصلية وعرض حاوية النتائج
            tabsContainer.style.display = 'none';
            resultsContainer.style.display = 'block';
            
            // مسح النتائج القديمة
            resultsList.innerHTML = '';
            
            if (foundStudents.length > 0) {
                foundStudents.forEach(student => {
                    const col = document.createElement('div');
                    col.className = 'col-md-6 col-lg-4 mb-3';
                    
                    const card = document.createElement('div');
                    card.className = 'student-card';
                    
                    // تعيين سلوك النقر حسب نوع المستخدم
                    if (currentUserType === 'limited') {
                        // المستخدم المحدود يمكنه فقط تسجيل الغياب
                        card.onclick = function(e) {
                            if (e.target.classList.contains('mark-absence-btn')) {
                                return;
                            }
                            return;
                        };
                    } else {
                        // المستخدم صاحب الصلاحيات الكاملة يمكنه عرض صفحة الطالب
                        card.onclick = () => openStudentPage(student.name, student.class);
                    }
                    
                    const details = studentDetails[student.name] || {};
                    const totalAbsences = (details.totalAbsences9 || 0) + (details.totalAbsences10 || 0);
                    const absenceInfo = totalAbsences > 0 ? 
                        `<div class="mt-2 text-danger"><i class="fas fa-exclamation-circle"></i> غيابات: ${totalAbsences}</div>` : '';
                    
                    card.innerHTML = `
                        <div class="student-name">
                            <span>${student.name}</span>
                            ${totalAbsences > 0 ? '<span class="absence-indicator">غياب</span>' : ''}
                        </div>
                        <div class="student-class">${student.grade} - ${student.class}</div>
                        ${absenceInfo}
                        ${currentUserType === 'limited' ? 
                            `<button class="mark-absence-btn" onclick="markSingleAbsence('${student.name}', '${student.class}', event)">
                                <i class="fas fa-calendar-times"></i> تسجيل غياب
                            </button>` : ''}
                    `;
                    
                    col.appendChild(card);
                    resultsList.appendChild(col);
                });
            } else {
                resultsList.innerHTML = `
                    <div class="col-12">
                        <div class="no-results">
                            <i class="fas fa-search fa-2x mb-3"></i>
                            <h4>لم يتم العثور على نتائج</h4>
                            <p>جرب البحث بكلمة أخرى</p>
                        </div>
                    </div>
                `;
            }
        }

        // مسح البحث
        function clearSearch() {
            document.getElementById('searchInput').value = '';
            document.getElementById('searchResultsContainer').style.display = 'none';
            document.getElementById('classTabsContainer').style.display = 'block';
        }

        // البحث بالضغط على Enter
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchStudents();
            }
        });

        // عرض صفحة الطلاب ذوي الغياب المرتفع
        function showHighAbsencePage() {
            if (currentUserType !== 'full') {
                return;
            }
            
            document.getElementById('mainPage').style.display = 'none';
            document.getElementById('studentPage').style.display = 'none';
            document.getElementById('highAbsencePage').style.display = 'block';
            document.getElementById('reportsPage').style.display = 'none';
            document.getElementById('schoolAbsencePage').style.display = 'none';
            
            filterHighAbsenceStudents();
        }

        // فلترة الطلاب ذوي الغياب المرتفع
        function filterHighAbsenceStudents() {
            const minAbsences = parseInt(document.getElementById('absenceFilter').value);
            const tableBody = document.getElementById('highAbsenceTableBody');
            
            // مسح المحتوى الحالي
            tableBody.innerHTML = '';
            
            // جمع جميع الطلاب ذوي الغياب المرتفع
            const highAbsenceStudents = [];
            
            for (const grade in studentsData) {
                for (const className in studentsData[grade]) {
                    studentsData[grade][className].forEach(studentName => {
                        const details = studentDetails[studentName] || {};
                        const systemAbsences = studentAbsences[studentName] || [];
                        const totalAbsences = (details.totalAbsences9 || 0) + (details.totalAbsences10 || 0) + systemAbsences.length;
                        
                        if (totalAbsences >= minAbsences) {
                            // دمج جميع تواريخ الغياب
                            const allAbsences = [];
                            
                            if (details.absences9) {
                                allAbsences.push(...details.absences9.split(', '));
                            }
                            
                            if (details.absences10) {
                                allAbsences.push(...details.absences10.split(', '));
                            }
                            
                            systemAbsences.forEach(absence => {
                                allAbsences.push(absence.date);
                            });
                            
                            highAbsenceStudents.push({
                                name: studentName,
                                grade: grade,
                                class: className,
                                nationalId: details.nationalId || '-',
                                phone: details.phone1 || details.phone2 || '-',
                                totalAbsences: totalAbsences,
                                absences: allAbsences.join(', ')
                            });
                        }
                    });
                }
            }
            
            // ترتيب حسب أيام الغياب (تنازلي)
            highAbsenceStudents.sort((a, b) => b.totalAbsences - a.totalAbsences);
            
            // ملء الجدول
            if (highAbsenceStudents.length > 0) {
                tableBody.innerHTML = highAbsenceStudents.map(student => `
                    <tr>
                        <td>${student.name}</td>
                        <td>${student.grade} - ${student.class}</td>
                        <td>${student.nationalId}</td>
                        <td>${student.phone}</td>
                        <td>${student.totalAbsences}</td>
                        <td>${student.absences}</td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">لا يوجد طلاب يحققون هذا الشرط</td>
                    </tr>
                `;
            }
        }

        // طباعة تقرير الغياب المرتفع
        function printHighAbsenceReport() {
            const minAbsences = document.getElementById('absenceFilter').value;
            const tableContent = document.getElementById('highAbsenceTable').outerHTML;
            
            if (tableContent.includes('لا يوجد طلاب يحققون هذا الشرط')) {
                showToast('لا توجد بيانات للطباعة', 'warning');
                return;
            }
            
            // بناء محتوى الطباعة
            const printContent = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>تقرير الطلاب ذوي الغياب المرتفع</title>
                    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
                    <style>
                        @page {
                            size: A4;
                            margin: 1.5cm;
                        }
                        body {
                            font-family: 'Tajawal', sans-serif;
                            font-size: 13px;
                            line-height: 1.6;
                            color: #333;
                            margin: 0;
                            padding: 0;
                        }
                        .report-header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #333;
                            padding-bottom: 15px;
                        }
                        .report-header h1 {
                            margin: 0;
                            font-size: 24px;
                            font-weight: 700;
                        }
                        .report-header h2 {
                            margin: 5px 0 0;
                            font-size: 16px;
                            font-weight: 500;
                        }
                        .absence-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                        }
                        .absence-table th, .absence-table td {
                            border: 1px solid #ddd;
                            padding: 12px;
                            text-align: right;
                        }
                        .absence-table th {
                            background-color: #f2f2f2;
                            font-weight: 600;
                        }
                        .absence-table tr:nth-child(even) {
                            background-color: #f9f9f9;
                        }
                        .report-footer {
                            text-align: center;
                            margin-top: 30px;
                            font-size: 12px;
                            color: #777;
                            border-top: 1px solid #ccc;
                            padding-top: 10px;
                        }
                    </style>
                </head>
                <body>
                    <div class="report-header">
                        <h1>مدرسة ابن خفاجة</h1>
                        <h2>تقرير الطلاب ذوي الغياب المرتفع (${minAbsences} أيام فأكثر)</h2>
                    </div>
                    
                    ${tableContent}
                    
                    <div class="report-footer">
                        <p>تم إنشاء هذا التقرير في ${new Date().toLocaleDateString('en-US')} ${new Date().toLocaleTimeString('en-US')}</p>
                        <p>نظام إدارة الطلاب - مدرسة ابن خفاجة</p>
                    </div>
                </body>
                </html>
            `;
            
            // فتح نافذة جديدة وكتابة المحتوى
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // انتظار تحميل المحتوى ثم الطباعة
            printWindow.onload = function() {
                printWindow.print();
                printWindow.onafterprint = function() {
                    printWindow.close();
                };
            };
        }

        // تصدير الطلاب ذوي الغياب المرتفع إلى Excel
        function exportHighAbsenceToExcel() {
            const minAbsences = document.getElementById('absenceFilter').value;
            const tableBody = document.getElementById('highAbsenceTableBody');
            
            if (tableBody.innerHTML.includes('لا يوجد طلاب يحققون هذا الشرط')) {
                showToast('لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            // جمع بيانات الجدول
            const rows = [];
            const tableRows = tableBody.querySelectorAll('tr');
            
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                
                cells.forEach(cell => {
                    rowData.push(cell.textContent);
                });
                
                rows.push(rowData);
            });
            
            // إنشاء مصنف العمل
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([
                ['اسم الطالب', 'الصف', 'الرقم الوطني', 'هاتف ولي الأمر', 'مجموع أيام الغياب', 'تواريخ الغياب'],
                ...rows
            ]);
            
            // إضافة ورقة العمل إلى المصنف
            XLSX.utils.book_append_sheet(wb, ws, 'الطلاب ذوي الغياب المرتفع');
            
            // تصدير الملف
            const fileName = `high_absence_students_${minAbsences}_days_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showToast('تم تصدير البيانات إلى Excel بنجاح!');
        }

        // عرض صفحة التقارير
        function showReportsPage() {
            if (currentUserType !== 'full') {
                return;
            }
            
            document.getElementById('mainPage').style.display = 'none';
            document.getElementById('studentPage').style.display = 'none';
            document.getElementById('highAbsencePage').style.display = 'none';
            document.getElementById('reportsPage').style.display = 'block';
            document.getElementById('schoolAbsencePage').style.display = 'none';
            
            // تهيئة بيانات التقارير
            filterAbsenceReport();
            filterActionsReport();
        }

        // تحديث فلاتر الشعبة في التقارير
        function updateReportClassFilter() {
            const grade = document.getElementById('reportGradeFilter').value;
            const classSelect = document.getElementById('reportClassFilter');
            
            // مسح الخيارات الحالية
            classSelect.innerHTML = '<option value="">جميع الشعب</option>';
            
            if (grade && studentsData[grade]) {
                // إضافة خيارات الشعب المتاحة للصف المحدد
                Object.keys(studentsData[grade]).forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    classSelect.appendChild(option);
                });
            }
            
            // إعادة فلترة تقرير الغياب
            filterAbsenceReport();
        }

        // تحديث فلاتر الشعبة في تقارير الإجراءات
        function updateActionsClassFilter() {
            const grade = document.getElementById('actionsGradeFilter').value;
            const classSelect = document.getElementById('actionsClassFilter');
            
            // مسح الخيارات الحالية
            classSelect.innerHTML = '<option value="">جميع الشعب</option>';
            
            if (grade && studentsData[grade]) {
                // إضافة خيارات الشعب المتاحة للصف المحدد
                Object.keys(studentsData[grade]).forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    classSelect.appendChild(option);
                });
            }
            
            // إعادة فلترة تقرير الإجراءات
            filterActionsReport();
        }

        // فلترة تقرير الغياب
        function filterAbsenceReport() {
            const grade = document.getElementById('reportGradeFilter').value;
            const className = document.getElementById('reportClassFilter').value;
            const dateFilter = document.getElementById('reportDateFilter').value;
            const tableBody = document.getElementById('absenceReportTableBody');
            
            // مسح المحتوى الحالي
            tableBody.innerHTML = '';
            
            // جمع جميع بيانات الغياب
            const absenceData = [];
            
            for (const g in studentsData) {
                if (grade && g !== grade) continue;
                
                for (const c in studentsData[g]) {
                    if (className && c !== className) continue;
                    
                    studentsData[g][c].forEach(studentName => {
                        const details = studentDetails[studentName] || {};
                        const systemAbsences = studentAbsences[studentName] || [];
                        const totalAbsences9 = details.totalAbsences9 || 0;
                        const totalAbsences10 = details.totalAbsences10 || 0;
                        const systemAbsencesCount = systemAbsences.length;
                        
                        let totalAbsences = 0;
                        let allAbsences = [];
                        
                        // تحديد الغيابات حسب فلتر التاريخ
                        if (dateFilter === 'all' || dateFilter === '9') {
                            totalAbsences += totalAbsences9;
                            if (details.absences9) {
                                allAbsences.push(...details.absences9.split(', '));
                            }
                        }
                        
                        if (dateFilter === 'all' || dateFilter === '10') {
                            totalAbsences += totalAbsences10;
                            if (details.absences10) {
                                allAbsences.push(...details.absences10.split(', '));
                            }
                        }
                        
                        if (dateFilter === 'all' || dateFilter === 'system') {
                            totalAbsences += systemAbsencesCount;
                            systemAbsences.forEach(absence => {
                                allAbsences.push(absence.date);
                            });
                        }
                        
                        if (totalAbsences > 0) {
                            absenceData.push({
                                name: studentName,
                                grade: g,
                                class: c,
                                nationalId: details.nationalId || '-',
                                phone: details.phone1 || details.phone2 || '-',
                                totalAbsences: totalAbsences,
                                absences: allAbsences.join(', ')
                            });
                        }
                    });
                }
            }
            
            // ترتيب حسب أيام الغياب (تنازلي)
            absenceData.sort((a, b) => b.totalAbsences - a.totalAbsences);
            
            // ملء الجدول
            if (absenceData.length > 0) {
                tableBody.innerHTML = absenceData.map(student => `
                    <tr>
                        <td>${student.name}</td>
                        <td>${student.grade} - ${student.class}</td>
                        <td>${student.nationalId}</td>
                        <td>${student.phone}</td>
                        <td>${student.totalAbsences}</td>
                        <td>${student.absences}</td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">لا توجد بيانات مطابقة للفلاتر</td>
                    </tr>
                `;
            }
        }

        // فلترة تقرير الإجراءات
        function filterActionsReport() {
            const grade = document.getElementById('actionsGradeFilter').value;
            const className = document.getElementById('actionsClassFilter').value;
            const actionType = document.getElementById('actionsTypeFilter').value;
            const tableBody = document.getElementById('actionsReportTableBody');
            
            // مسح المحتوى الحالي
            tableBody.innerHTML = '';
            
            // جمع جميع بيانات الإجراءات
            const actionsData = [];
            
            for (const g in studentsData) {
                if (grade && g !== grade) continue;
                
                for (const c in studentsData[g]) {
                    if (className && c !== className) continue;
                    
                    studentsData[g][c].forEach(studentName => {
                        const actions = studentActions[studentName] || [];
                        
                        actions.forEach(action => {
                            if (!actionType || action.type === actionType) {
                                actionsData.push({
                                    name: studentName,
                                    grade: g,
                                    class: c,
                                    type: action.type,
                                    date: action.date,
                                    time: action.time,
                                    note: action.note || '-'
                                });
                            }
                        });
                    });
                }
            }
            
            // ترتيب حسب التاريخ (تنازلي)
            actionsData.sort((a, b) => {
                const dateA = a.date.split('/').reverse().join('-');
                const dateB = b.date.split('/').reverse().join('-');
                return new Date(dateB) - new Date(dateA);
            });
            
            // ملء الجدول
            if (actionsData.length > 0) {
                tableBody.innerHTML = actionsData.map(action => `
                    <tr>
                        <td>${action.name}</td>
                        <td>${action.grade} - ${action.class}</td>
                        <td>${action.type}</td>
                        <td>${action.date}</td>
                        <td>${action.time}</td>
                        <td>${action.note}</td>
                    </tr>
                `).join('');
            } else {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center">لا توجد بيانات مطابقة للفلاتر</td>
                    </tr>
                `;
            }
        }

        // طباعة تقرير الغياب
        function printAbsenceReport() {
            const tableContent = document.getElementById('absenceReportTable').outerHTML;
            
            // بناء محتوى الطباعة
            const printContent = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>تقرير الغياب</title>
                    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
                    <style>
                        @page {
                            size: A4;
                            margin: 1.5cm;
                        }
                        body {
                            font-family: 'Tajawal', sans-serif;
                            font-size: 13px;
                            line-height: 1.6;
                            color: #333;
                            margin: 0;
                            padding: 0;
                        }
                        .report-header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #333;
                            padding-bottom: 15px;
                        }
                        .report-header h1 {
                            margin: 0;
                            font-size: 24px;
                            font-weight: 700;
                        }
                        .report-header h2 {
                            margin: 5px 0 0;
                            font-size: 16px;
                            font-weight: 500;
                        }
                        .absence-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                        }
                        .absence-table th, .absence-table td {
                            border: 1px solid #ddd;
                            padding: 12px;
                            text-align: right;
                        }
                        .absence-table th {
                            background-color: #f2f2f2;
                            font-weight: 600;
                        }
                        .absence-table tr:nth-child(even) {
                            background-color: #f9f9f9;
                        }
                        .report-footer {
                            text-align: center;
                            margin-top: 30px;
                            font-size: 12px;
                            color: #777;
                            border-top: 1px solid #ccc;
                            padding-top: 10px;
                        }
                    </style>
                </head>
                <body>
                    <div class="report-header">
                        <h1>مدرسة ابن خفاجة</h1>
                        <h2>تقرير الغياب</h2>
                    </div>
                    
                    ${tableContent}
                    
                    <div class="report-footer">
                        <p>تم إنشاء هذا التقرير في ${new Date().toLocaleDateString('en-US')} ${new Date().toLocaleTimeString('en-US')}</p>
                        <p>نظام إدارة الطلاب - مدرسة ابن خفاجة</p>
                    </div>
                </body>
                </html>
            `;
            
            // فتح نافذة جديدة وكتابة المحتوى
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // انتظار تحميل المحتوى ثم الطباعة
            printWindow.onload = function() {
                printWindow.print();
                printWindow.onafterprint = function() {
                    printWindow.close();
                };
            };
        }

        // طباعة تقرير الإجراءات
        function printActionsReport() {
            const tableContent = document.getElementById('actionsReportTable').outerHTML;
            
            // بناء محتوى الطباعة
            const printContent = `
                <!DOCTYPE html>
                <html dir="rtl" lang="ar">
                <head>
                    <meta charset="UTF-8">
                    <title>تقرير الإجراءات</title>
                    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
                    <style>
                        @page {
                            size: A4;
                            margin: 1.5cm;
                        }
                        body {
                            font-family: 'Tajawal', sans-serif;
                            font-size: 13px;
                            line-height: 1.6;
                            color: #333;
                            margin: 0;
                            padding: 0;
                        }
                        .report-header {
                            text-align: center;
                            margin-bottom: 30px;
                            border-bottom: 2px solid #333;
                            padding-bottom: 15px;
                        }
                        .report-header h1 {
                            margin: 0;
                            font-size: 24px;
                            font-weight: 700;
                        }
                        .report-header h2 {
                            margin: 5px 0 0;
                            font-size: 16px;
                            font-weight: 500;
                        }
                        .absence-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-top: 20px;
                        }
                        .absence-table th, .absence-table td {
                            border: 1px solid #ddd;
                            padding: 12px;
                            text-align: right;
                        }
                        .absence-table th {
                            background-color: #f2f2f2;
                            font-weight: 600;
                        }
                        .absence-table tr:nth-child(even) {
                            background-color: #f9f9f9;
                        }
                        .report-footer {
                            text-align: center;
                            margin-top: 30px;
                            font-size: 12px;
                            color: #777;
                            border-top: 1px solid #ccc;
                            padding-top: 10px;
                        }
                    </style>
                </head>
                <body>
                    <div class="report-header">
                        <h1>مدرسة ابن خفاجة</h1>
                        <h2>تقرير الإجراءات</h2>
                    </div>
                    
                    ${tableContent}
                    
                    <div class="report-footer">
                        <p>تم إنشاء هذا التقرير في ${new Date().toLocaleDateString('en-US')} ${new Date().toLocaleTimeString('en-US')}</p>
                        <p>نظام إدارة الطلاب - مدرسة ابن خفاجة</p>
                    </div>
                </body>
                </html>
            `;
            
            // فتح نافذة جديدة وكتابة المحتوى
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printContent);
            printWindow.document.close();
            
            // انتظار تحميل المحتوى ثم الطباعة
            printWindow.onload = function() {
                printWindow.print();
                printWindow.onafterprint = function() {
                    printWindow.close();
                };
            };
        }

        // تصدير تقرير الغياب إلى Excel
        function exportAbsenceReportToExcel() {
            const tableBody = document.getElementById('absenceReportTableBody');
            
            if (tableBody.innerHTML.includes('لا توجد بيانات مطابقة للفلاتر')) {
                showToast('لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            // جمع بيانات الجدول
            const rows = [];
            const tableRows = tableBody.querySelectorAll('tr');
            
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                
                cells.forEach(cell => {
                    rowData.push(cell.textContent);
                });
                
                rows.push(rowData);
            });
            
            // إنشاء مصنف العمل
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([
                ['اسم الطالب', 'الصف', 'الرقم الوطني', 'هاتف ولي الأمر', 'مجموع الغياب', 'تواريخ الغياب'],
                ...rows
            ]);
            
            // إضافة ورقة العمل إلى المصنف
            XLSX.utils.book_append_sheet(wb, ws, 'تقرير الغياب');
            
            // تصدير الملف
            const fileName = `absence_report_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showToast('تم تصدير البيانات إلى Excel بنجاح!');
        }

        // تصدير تقرير الإجراءات إلى Excel
        function exportActionsReportToExcel() {
            const tableBody = document.getElementById('actionsReportTableBody');
            
            if (tableBody.innerHTML.includes('لا توجد بيانات مطابقة للفلاتر')) {
                showToast('لا توجد بيانات للتصدير', 'warning');
                return;
            }
            
            // جمع بيانات الجدول
            const rows = [];
            const tableRows = tableBody.querySelectorAll('tr');
            
            tableRows.forEach(row => {
                const cells = row.querySelectorAll('td');
                const rowData = [];
                
                cells.forEach(cell => {
                    rowData.push(cell.textContent);
                });
                
                rows.push(rowData);
            });
            
            // إنشاء مصنف العمل
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet([
                ['اسم الطالب', 'الصف', 'نوع الإجراء', 'التاريخ', 'الوقت', 'الملاحظات'],
                ...rows
            ]);
            
            // إضافة ورقة العمل إلى المصنف
            XLSX.utils.book_append_sheet(wb, ws, 'تقرير الإجراءات');
            
            // تصدير الملف
            const fileName = `actions_report_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
            
            showToast('تم تصدير البيانات إلى Excel بنجاح!');
        }

        // تفعيل وضع الطوارئ
        function activateEmergencyMode() {
            const password = prompt('أدخل كلمة المرور لتفعيل وضع الطوارئ:');
            
            if (password === '654321') {
                emergencyMode = true;
                document.body.classList.add('emergency-mode');
                document.getElementById('emergencyAlert').classList.add('active');
                
                // تشغيل صوت الطوارئ (إذا لزم الأمر)
                playEmergencySound();
                
                // إرسال إشعار الطوارئ (إذا لزم الأمر)
                sendEmergencyNotification();
            } else if (password !== null) {
                showToast('كلمة المرور غير صحيحة', 'error');
            }
        }

        // إيقاف وضع الطوارئ
        function stopEmergencyMode() {
            const password = prompt('أدخل كلمة المرور لإيقاف وضع الطوارئ:');
            
            if (password === '654321') {
                emergencyMode = false;
                document.body.classList.remove('emergency-mode');
                document.getElementById('emergencyAlert').classList.remove('active');
                
                // إيقاف صوت الطوارئ
                if (emergencyAudio) {
                    emergencyAudio.pause();
                    emergencyAudio = null;
                }
                
                showToast('تم إيقاف وضع الطوارئ');
            } else if (password !== null) {
                showToast('كلمة المرور غير صحيحة', 'error');
            }
        }

        // تشغيل صوت الطوارئ
        function playEmergencySound() {
            // هنا يمكن إضافة كود تشغيل صوت الطوارئ
            // على سبيل المثال استخدام Web Audio API أو عنصر HTML5 Audio
            try {
                emergencyAudio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSp9v+/blkkMGVOo5+2sWRYMUqzn77RmGgU7k9n1unEiBC13yO/eizEIHWq+8+OZURE');
                emergencyAudio.loop = true;
                emergencyAudio.play().catch(e => console.error('Error playing emergency sound:', e));
            } catch (e) {
                console.error('Error creating emergency sound:', e);
            }
        }

        // إرسال إشعار الطوارئ
        function sendEmergencyNotification() {
            // هنا يمكن إضافة كود إرسال إشعار الطوارئ
            // على سبيل المثال إرسال بريد إلكتروني أو رسالة نصية أو إشعار دفع
            console.log('Emergency notification sent');
        }

        // عرض نافذة إضافة طالب
        function showAddStudentModal() {
            if (currentUserType !== 'full') {
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('addStudentModal'));
            modal.show();
            
            // تعيين مستمعي الأحداث لتحديث خيارات الشعبة عند تغيير الصف
            document.getElementById('newStudentGrade').addEventListener('change', updateClassOptions);
            
            // تحميل خيارات الشعبة الافتراضية
            updateClassOptions();
        }

        // تحديث خيارات الشعبة
        function updateClassOptions() {
            const grade = document.getElementById('newStudentGrade').value;
            const classSelect = document.getElementById('newStudentClass');
            
            // مسح الخيارات الحالية
            classSelect.innerHTML = '<option value="" selected disabled>اختر الشعبة</option>';
            
            if (grade && studentsData[grade]) {
                // إضافة خيارات الشعب المتاحة للصف المحدد
                Object.keys(studentsData[grade]).forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    classSelect.appendChild(option);
                });
            }
        }

        // إضافة طالب جديد
        function addNewStudent() {
            if (currentUserType !== 'full') {
                return;
            }
            
            const name = document.getElementById('newStudentName').value.trim();
            const nationalId = document.getElementById('newStudentNationalId').value.trim();
            const birthDate = document.getElementById('newStudentBirthDate').value;
            const address = document.getElementById('newStudentAddress').value.trim();
            const phone1 = document.getElementById('newStudentPhone1').value.trim();
            const phone2 = document.getElementById('newStudentPhone2').value.trim();
            const email = document.getElementById('newStudentEmail').value.trim();
            const parentName = document.getElementById('newStudentParentName').value.trim();
            const grade = document.getElementById('newStudentGrade').value;
            const className = document.getElementById('newStudentClass').value;
            
            // التحقق من الحقول المطلوبة
            if (!name || !grade || !className) {
                showToast('الرجاء ملء الحقول المطلوبة (اسم الطالب، الصف، والشعبة)', 'warning');
                return;
            }
            
            // التحقق من وجود الطالب مسبقاً
            for (const g in studentsData) {
                for (const c in studentsData[g]) {
                    if (studentsData[g][c].includes(name)) {
                        showToast('الطالب موجود بالفعل في النظام', 'warning');
                        return;
                    }
                }
            }
            
            // إضافة الطالب إلى قاعدة البيانات
            if (!studentsData[grade]) {
                studentsData[grade] = {};
            }
            
            if (!studentsData[grade][className]) {
                studentsData[grade][className] = [];
            }
            
            studentsData[grade][className].push(name);
            
            // حفظ تفاصيل الطالب
            if (nationalId || birthDate || address || phone1 || phone2 || email || parentName) {
                studentInfo[name] = {
                    nationalId,
                    birthDate,
                    address,
                    phone1,
                    phone2,
                    email,
                    parentName
                };
                
                // حفظ في التخزين المحلي
                localStorage.setItem('studentInfo', JSON.stringify(studentInfo));
            }
            
            // حفظ بيانات الطلاب في التخزين المحلي
            localStorage.setItem('studentsData', JSON.stringify(studentsData));
            
            // إغلاق النافذة المنبثقة
            bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
            
            // إعادة تعيين النموذج
            document.getElementById('addStudentForm').reset();
            
            // تحديث الواجهة
            createClassTabs();
            updateStats();
            
            // عرض رسالة نجاح
            showToast(`تم إضافة الطالب ${name} بنجاح!`);
        }

        // عرض رسالة نجاح
        function showToast(message, type = 'success') {
            document.getElementById('toastMessage').textContent = message;
            const toastElement = document.getElementById('successToast');
            
            // تعديل لون الرسالة حسب النوع
            toastElement.className = 'toast';
            if (type === 'error') {
                toastElement.classList.add('error');
            } else if (type === 'warning') {
                toastElement.classList.add('warning');
            }
            
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }

        // عرض نافذة الإعدادات
        function showSettingsModal() {
            if (currentUserType !== 'full') {
                return;
            }
            
            const modal = new bootstrap.Modal(document.getElementById('settingsModal'));
            modal.show();
            
            // تحميل معلومات النظام الحالية
            const schoolName = localStorage.getItem('schoolName') || 'مدرسة ابن خفاجة';
            const systemName = localStorage.getItem('systemName') || 'نظام إدارة الطلاب المتقدم';
            const lastBackup = localStorage.getItem('lastBackup') || 'غير متوفر';
            
            document.getElementById('schoolName').value = schoolName;
            document.getElementById('systemName').value = systemName;
            document.getElementById('lastBackup').value = lastBackup;
        }

        // إعداد التحقق من كلمة المرور
        function setupPasswordValidation() {
            const newPasswordInput = document.getElementById('newPassword');
            const confirmPasswordInput = document.getElementById('confirmPassword');
            const passwordStrengthBar = document.getElementById('passwordStrengthBar');
            const lengthReq = document.getElementById('length-req');
            const uppercaseReq = document.getElementById('uppercase-req');
            const numberReq = document.getElementById('number-req');
            
            newPasswordInput.addEventListener('input', function() {
                const password = this.value;
                
                // التحقق من متطلبات كلمة المرور
                const hasLength = password.length >= 8;
                const hasUppercase = /[A-Z]/.test(password);
                const hasNumber = /[0-9]/.test(password);
                
                // تحديث متطلبات كلمة المرور
                updateRequirement(lengthReq, hasLength);
                updateRequirement(uppercaseReq, hasUppercase);
                updateRequirement(numberReq, hasNumber);
                
                // تحديث مؤشر قوة كلمة المرور
                passwordStrengthBar.className = 'password-strength-bar';
                
                if (hasLength && hasUppercase && hasNumber) {
                    passwordStrengthBar.classList.add('strength-strong');
                } else if (hasLength && (hasUppercase || hasNumber)) {
                    passwordStrengthBar.classList.add('strength-medium');
                } else if (hasLength) {
                    passwordStrengthBar.classList.add('strength-weak');
                }
            });
            
            confirmPasswordInput.addEventListener('input', function() {
                const newPassword = newPasswordInput.value;
                const confirmPassword = this.value;
                
                if (confirmPassword && newPassword !== confirmPassword) {
                    this.classList.add('is-invalid');
                } else {
                    this.classList.remove('is-invalid');
                }
            });
        }

        // تحديث المتطلب
        function updateRequirement(element, isMet) {
            if (isMet) {
                element.classList.remove('unmet');
                element.classList.add('met');
                element.innerHTML = element.innerHTML.replace('fa-times-circle', 'fa-check-circle');
            } else {
                element.classList.remove('met');
                element.classList.add('unmet');
                element.innerHTML = element.innerHTML.replace('fa-check-circle', 'fa-times-circle');
            }
        }

        // حفظ الإعدادات
        function saveSettings() {
            if (currentUserType !== 'full') {
                return;
            }
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const schoolName = document.getElementById('schoolName').value;
            const systemName = document.getElementById('systemName').value;
            
            // التحقق من كلمة المرور الحالية
            if (currentPassword !== '110527') {
                showToast('كلمة المرور الحالية غير صحيحة', 'error');
                return;
            }
            
            // التحقق من تطابق كلمة المرور الجديدة
            if (newPassword !== confirmPassword) {
                showToast('كلمتا المرور الجديدة غير متطابقتين', 'error');
                return;
            }
            
            // التحقق من متطلبات كلمة المرور
            const hasLength = newPassword.length >= 8;
            const hasUppercase = /[A-Z]/.test(newPassword);
            const hasNumber = /[0-9]/.test(newPassword);
            
            if (!hasLength || !hasUppercase || !hasNumber) {
                showToast('كلمة المرور الجديدة لا تلبي المتطلبات المطلوبة', 'error');
                return;
            }
            
            // حفظ كلمة المرور الجديدة
            localStorage.setItem('adminPassword', newPassword);
            
            // حفظ معلومات النظام
            localStorage.setItem('schoolName', schoolName);
            localStorage.setItem('systemName', systemName);
            localStorage.setItem('lastBackup', new Date().toLocaleDateString('ar-SA'));
            
            // تحديث الواجهة
            document.querySelector('.school-name').textContent = schoolName;
            document.querySelector('.system-title').textContent = systemName;
            
            // إغلاق النافذة المنبثقة
            bootstrap.Modal.getInstance(document.getElementById('settingsModal')).hide();
            
            // إعادة تعيين النموذج
            document.getElementById('changePasswordForm').reset();
            
            // عرض رسالة نجاح
            showToast('تم حفظ الإعدادات بنجاح!');
        }

        // تحميل بيانات الطلاب من التخزين المحلي
        function loadStudentsFromStorage() {
            const storedData = localStorage.getItem('studentsData');
            if (storedData) {
                try {
                    const parsedData = JSON.parse(storedData);
                    // دمج البيانات المخزنة مع البيانات الأصلية
                    for (const grade in parsedData) {
                        if (!studentsData[grade]) {
                            studentsData[grade] = {};
                        }
                        for (const className in parsedData[grade]) {
                            if (!studentsData[grade][className]) {
                                studentsData[grade][className] = [];
                            }
                            // إضافة الطلاب الجدد فقط
                            parsedData[grade][className].forEach(student => {
                                if (!studentsData[grade][className].includes(student)) {
                                    studentsData[grade][className].push(student);
                                }
                            });
                        }
                    }
                } catch (e) {
                    console.error('Error loading students data from storage:', e);
                }
            }
        }

        // عند تحميل النافذة استدعاء دالة تحميل البيانات
        window.addEventListener('load', function() {
            loadStudentsFromStorage();
            
            // تحميل معلومات النظام المحفوظة
            const schoolName = localStorage.getItem('schoolName');
            const systemName = localStorage.getItem('systemName');
            
            if (schoolName) {
                document.querySelector('.school-name').textContent = schoolName;
            }
            
            if (systemName) {
                document.querySelector('.system-title').textContent = systemName;
            }
        });
    </script>
</body>
</html>

